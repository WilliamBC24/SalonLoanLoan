<!DOCTYPE html>

<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Registration</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        input[type="text"], input[type="time"], input[type="date"], select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .service-list { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .service-item { padding: 5px; cursor: pointer; border-bottom: 1px solid #eee; }
        .service-item:hover { background: #f0f0f0; }
        .selected-services { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 5px; }
        .summary { margin-top: 20px; padding: 10px; background: #e0f7fa; border-radius: 5px; }
        .blocked { background: #ffcccc; cursor: not-allowed; }
        button { padding: 10px 20px; background: #3b82f6; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }

        .customer-info input[type="text"],
        .customer-info input[type="tel"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .customer-info input[type="text"]:focus,
        .customer-info input[type="tel"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
            outline: none;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body>
<div class="container">
    <h1>Book an Appointment</h1>
    <h2 id="error"></h2>

    <form th:action="@{/appointment/book}" method="post" id="appointment-form">
        <label for="service-search">Search Services:</label>
        <input type="text" id="service-search" name="serviceSearch" placeholder="Type to search services...">

        <div class="service-list" id="service-list">
            <!-- Services will be populated dynamically -->
        </div>

        <div class="selected-services" id="selected-services">
            <strong>Selected Services:</strong>
            <ul id="selected-services-list"></ul>
            <!-- Hidden input to send selected services JSON -->
            <input type="hidden" id="selected-services-input" name="selectedServices">
        </div>

        <div class="customer-info">
            <label for="customer-name">Full Name:</label>
            <input type="text" id="customer-name" name="name" th:value="${customerName}" placeholder="Enter your name" required>

            <label for="phone-number">Phone Number:</label>
            <input type="tel" id="phone-number" name="phoneNumber" th:value="${phoneNumber}" placeholder="Enter your phone number" required pattern="^\+?[0-9]{7,15}$">
        </div>


        <label for="appointment-date">Select Date:</label>
        <input type="date" id="appointment-date" name="appointmentDate" th:value="${appointmentDate}" required>

        <label for="appointment-time">Select Time:</label>
        <input type="time" id="appointment-time" name="appointmentTime" th:value="${appointmentTime}" required>

        <div class="summary">
            <p>Estimated Duration: <span id="total-duration">0</span> minutes</p>
            <input type="hidden" id="total-duration-input" name="totalDuration" th:value="${totalDuration}">
            <p>Estimated Price: $<span id="total-price">0</span></p>
            <input type="hidden" id="total-price-input" name="totalPrice" th:value="${totalPrice}">
            <p>End Time: <span id="end-time">--:--</span></p>
            <input type="hidden" id="end-time-input" name="endTime" th:value="${endTime}">
        </div>

        <button type="submit" id="book-appointment">Book Appointment</button>
    </form>
    <div th:if="${param.error}" class="message">
        Invalid inputs
    </div>
    <div th:if="${param.success}" class="message">
        Registered successfully
    </div>
</div>

<script>

    $(document).ready(function() {
//         let blockedDates = []; // fetched from backend
//
// // Example: fetch blocked dates on page load
//         $.ajax({
//             url: '/appointments/blocked-dates',
//             method: 'GET',
//             success: function(data) {
//                 blockedDates = data; // array of strings YYYY-MM-DD
//             }
//         });
//
//         $("#appointment-date").on("input", function() {
//             const selected = $(this).val();
//             if (blockedDates.includes(selected)) {
//                 alert("Selected date is unavailable. Please choose another date.");
//                 $(this).val("");
//             }
//         });
//         let blockedSlots = {}; // { "2025-11-05": [{start: "15:00", end: "19:00"}], ... }
//
//         $("#appointment-date").on("change", function() {
//             const date = $(this).val();
//             if (!date) return;
//
//             // Fetch blocked slots for this date
//             $.ajax({
//                 url: `/appointments/blocked-slots/${date}`,
//                 method: "GET",
//                 success: function(slots) {
//                     blockedSlots[date] = slots; // array of {start, end}
//                 }
//             });
//         });
//
//         $("#appointment-time").on("change", function() {
//             const date = $("#appointment-date").val();
//             const time = $(this).val();
//             if (!date || !time) return;
//
//             const dayBlocked = blockedSlots[date] || [];
//             for (const slot of dayBlocked) {
//                 if (time >= slot.start && time < slot.end) {
//                     alert("Selected time is unavailable. Please choose another time.");
//                     $(this).val("");
//                     return;
//                 }
//             }
//         });
//
//
        let debounceTimer;
        $("#service-search").on("input", function() {
            const query = $(this).val().trim();

            // Only search if 2+ characters
            if (query.length < 2) {
                $("#service-list").empty();
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                $.ajax({
                    url: `/services/search`,
                    method: "GET",
                    data: { query: query },
                    success: function(data) {
                        // Assume data is an array of services: [{id, name, price, duration}, ...]
                        renderServices(data);
                    },
                    error: function(err) {
                        console.error("Error fetching services", err);
                    }
                });
            }, 300); // 300ms debounce
        });


        // Sample blocked slots from backend (date + time ranges)
        // const blockedSlots = {
        //     "2025-11-05": [{ start: "15:00", end: "19:00" }]
        // };

        let selectedServices = [];
        let selectedServicesId = [];

        function renderServices(list) {
            $("#service-list").empty();
            list.forEach(s => {
                $("#service-list").append(`<div class="service-item" data-id="${s.id}" data-name="${s.serviceName}" data-price="${s.servicePrice}" data-duration="${s.durationMinutes}">
                ${s.serviceName} - $${s.servicePrice} - ${s.durationMinutes} min
            </div>`);
            });
        }

        $("#service-list").on("click", ".service-item", function() {
            const id = parseInt($(this).data("id"));
            const name = $(this).data("name");
            const price = parseFloat($(this).data("price"));
            const duration = parseInt($(this).data("duration"));

            // prevent duplicates by checking name
            if (!selectedServices.some(s => s.name === name)) {
                const service = { id, name, price, duration };
                selectedServices.push(service);
                selectedServicesId.push(service.id);

                $("#selected-services-list").append(`
            <li data-id="${id}" data-name="${name}">
                ${name} - $${price} - ${duration} min
                <button class="remove-service">Remove</button>
            </li>
        `);
                updateSummary();
                updateSelectedServicesInput();
            }
        });

        $("#selected-services-list").on("click", ".remove-service", function() {
            const li = $(this).closest("li");
            const serviceName = li.data("name");
            const serviceId =li.data("id");
            selectedServices = selectedServices.filter(s => s.name !== serviceName);
            selectedServicesId = selectedServicesId.filter(id => id !== serviceId);
            li.remove();
            updateSummary();
            updateSelectedServicesInput();
        });

        function updateSummary() {
            const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const totalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);
            $("#total-duration").text(totalDuration);
            $("#total-price").text(totalPrice);
            $("#total-duration-input").val(totalDuration);
            $("#total-price-input").val(totalPrice);
            updateEndTime();
        }

        function updateEndTime() {
            const startTime = $("#appointment-time").val();
            if (!startTime || selectedServices.length === 0) {
                $("#end-time").text("--:--");
                return;
            }
            const totalMinutes = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const [hours, minutes] = startTime.split(":").map(Number);
            let date = new Date();
            date.setHours(hours, minutes);
            date.setMinutes(date.getMinutes() + totalMinutes);

            const endHours = date.getHours().toString().padStart(2, "0");
            const endMinutes = date.getMinutes().toString().padStart(2, "0");
            const endTimeStr = `${endHours}:${endMinutes}`;
            $("#end-time").text(endTimeStr);
            $("#end-time-input").val(endTimeStr);
        }

        $("#appointment-time, #appointment-date").on("change", function() {
            const date = $("#appointment-date").val();
            const time = $("#appointment-time").val();
            if (!date || !time) return;

            const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const [hours, minutes] = time.split(":").map(Number);
            let startDateTime = new Date(`${date}T${time}`);
            let endDateTime = new Date(startDateTime);
            endDateTime.setMinutes(endDateTime.getMinutes() + totalDuration);

            // Check if appointment goes beyond closing time (19:00)
            const closingTime = new Date(`${date}T19:00`);
            if (endDateTime > closingTime) {
                $("#error").text("Selected services exceed closing time. Please pick an earlier time or fewer services.")
                return;
            }
            $("#error").text("")

            // Check against blocked slots
            // const dayBlocked = blockedSlots[date] || [];
            // for (const slot of dayBlocked) {
            //     const blockStart = new Date(`${date}T${slot.start}`);
            //     const blockEnd = new Date(`${date}T${slot.end}`);
            //     if (startDateTime < blockEnd && endDateTime > blockStart) {
            //         alert("Selected time overlaps with a blocked slot. Please choose another time.");
            //         $("#appointment-time").val("");
            //         $("#end-time").text("--:--");
            //         return;
            //     }
            // }

            updateEndTime();
        });

        function updateSelectedServicesInput() {
            $("#selected-services-input").val(selectedServicesId.join(","));
        }
    });
</script>

</body>
</html>
