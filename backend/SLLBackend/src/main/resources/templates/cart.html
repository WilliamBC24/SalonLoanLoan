<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi" th:lang="${#locale}">
<head>
    <meta charset="UTF-8" />
    <title th:text="#{cart.page.title}">Shopping Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/cart.css}" />
</head>
<body>
    <div th:replace="fragments/header :: top-header"></div>
    <div th:replace="fragments/header :: navbar"></div>


    <main class="cart-main">
        <div class="container-xl">
            <div class="page-header">
                <div class="header-content">
                    <h1 class="page-title">
                        <span th:text="#{cart.header.title}">Shopping Cart</span>
                    </h1>
                </div>
            </div>


            <div class="cart-content">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="cart-items">
                            <div th:if="${#lists.isEmpty(cartItems)}" class="empty-cart">
                                <div class="text-center py-5">
                                    <h4 class="text-muted" th:text="#{cart.empty.title}">Your cart is empty</h4>
                                    <p class="text-muted" th:text="#{cart.empty.desc}">Start shopping to add items to your cart!</p>
                                    <a href="/products" class="btn btn-primary" th:text="#{cart.browse.products}">Browse Products</a>
                                </div>
                            </div>
                            <div th:if="${!#lists.isEmpty(cartItems)}" class="p-3">
                                <table class="cart-table">
                                    <thead>
                                        <tr>
                                            <th th:text="#{cart.table.header.product}">Product</th>
                                            <th th:text="#{cart.table.header.price}">Price</th>
                                            <th th:text="#{cart.table.header.quantity}">Quantity</th>
                                            <th th:text="#{cart.table.header.total}">Total</th>
                                            <th th:text="#{cart.table.header.actions}">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="item : ${cartItems}">
                                            <td>
                                                <a th:href="@{/products/{id}(id=${item.product.id})}"
                                                   th:text="${item.product.productName}"
                                                   class="product-name">Product Name</a>
                                            </td>
                                            <td>
                                                <span class="price" th:text="${item.product.currentPrice} + ' ' + #{currency.unit}">0</span>
                                            </td>
                                            <td>
                                                <input type="number"
                                                       th:data-product-id="${item.product.id}"
                                                       th:data-price="${item.product.currentPrice}"
                                                       th:value="${item.amount}"
                                                       min="1"
                                                       class="quantity-input"
                                                       onchange="updateQuantity(this)" />
                                            </td>
                                            <td>
                                                <span class="price"
                                                      th:id="'item-total-' + ${item.product.id}"
                                                      th:text="${item.product.currentPrice * item.amount} + ' ' + #{currency.unit}">0</span>
                                            </td>
                                            <td>
                                                <form action="/cart/remove" method="post" style="display: inline;">
                                                    <input type="hidden" name="productId" th:value="${item.product.id}" />
                                                    <button type="submit" class="remove-btn" th:text="#{cart.remove}">Remove</button>
                                                </form>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="order-summary">
                            <div class="summary-header">
                                <h3>
                                    <span th:text="#{cart.summary.total}">Total Cart Price:</span>
                                </h3>
                            </div>
                            <div class="summary-content">
                                <div class="summary-row total-row">
                                    <span th:text="#{cart.summary.total}">Total</span>
                                    <span class="total-price" id="total-price" th:text="${totalPrice} + ' ' + #{currency.unit}">0</span>
                                </div>
                            </div>
                            <div class="summary-actions">
                                <a href="/products" class="btn btn-outline-secondary btn-continue">
                                    <span th:text="#{cart.continue.shopping}">Continue Shopping</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <div th:replace="fragments/footer :: footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const currencyUnit = /*[[#{currency.unit}]]*/ 'VND';
        function updateQuantity(input) {
            const productId = input.getAttribute('data-product-id');
            const amount = input.value;
            const price = parseInt(input.getAttribute('data-price'));
           
            if (amount < 1) {
                input.value = 1;
                return;
            }
           
            // Send AJAX request to update quantity
            fetch('/cart/api/update-quantity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `productId=${productId}&amount=${amount}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the item total
                    const itemTotalElement = document.getElementById('item-total-' + productId);
                    if (itemTotalElement && data.itemTotal !== undefined) {
                        itemTotalElement.textContent = data.itemTotal + ' ' + currencyUnit;
                    }
                   
                    // Update the total price
                    const totalPriceElement = document.getElementById('total-price');
                    if (totalPriceElement && data.totalPrice !== undefined) {
                        totalPriceElement.textContent = data.totalPrice + ' ' + currencyUnit;
                    }
                }
            })
            .catch(error => {
                console.error(/*[[#{cart.js.error.updating.quantity}]]*/ 'Error updating quantity', error);
                // Optionally reload the page on error
                // location.reload();
            });
        }
    </script>


</body>
</html>
