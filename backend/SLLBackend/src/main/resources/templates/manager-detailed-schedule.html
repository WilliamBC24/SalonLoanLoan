<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title th:text="#{schedule.day.pageTitle}">Manager - Day Schedule | Salon Loan Loan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Global staff layout styles (sidebar + main scroll) -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <style>
        .schedule-page {
            padding: 2.5rem 0 3rem;
            background: var(--bg-light);
            min-height: 100vh;
        }

        .schedule-layout-inner {
            max-width: 90vw;
            width: 100%;
            margin: 1rem auto;
            padding: 0 1.5rem;
        }

        .schedule-card {
            background: #ffffff;
            padding: 2.2rem;
            border-radius: var(--radius-lg);
            border: 1px solid #e8e8e8;
            box-shadow: var(--shadow-soft);
        }

        .schedule-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .schedule-title-block {
            text-align: left;
        }

        .schedule-subtext {
            margin: 0.2rem 0 0;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .schedule-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            font-size: 0.85rem;
            color: #2563eb;
            text-decoration: none;
            border-radius: 999px;
            border: 1px solid #bfdbfe;
            padding: 0.2rem 0.6rem;
            background: #eff6ff;
        }

        .back-link:hover {
            background: #dbeafe;
        }

        .day-date-label {
            font-weight: 600;
        }

        .schedule-main-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr);
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .schedule-layout-inner {
                padding: 0;
            }
            .schedule-card {
                padding: 1.6rem 1.4rem;
            }
            .schedule-main-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        /* Shift section */
        .shift-section {
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            padding: 1.1rem 1.2rem;
            background: #f9fafb;
        }

        .shift-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.7rem;
        }

        .shift-section-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .shift-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .shift-block {
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            padding: 0.7rem 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .shift-block-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .shift-name-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            background: #eef2ff;
            color: #1e293b;
            font-weight: 600;
        }

        .shift-time {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .shift-staff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.15rem;
        }

        .staff-chip {
            border-radius: 999px;
            padding: 0.15rem 0.55rem;
            font-size: 0.78rem;
            background: #ecfeff;
            color: #0f172a;
            border: 1px solid #bae6fd;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .staff-chip button {
            border: none;
            background: transparent;
            font-size: 0.8rem;
            cursor: pointer;
            color: #64748b;
        }

        .staff-chip button:hover {
            color: #ef4444;
        }

        .shift-suggestion {
            font-size: 0.78rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .suggestion-highlight {
            font-weight: 500;
            color: #111827;
        }

        .shift-add-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.25rem;
        }

        .shift-add-row label {
            font-size: 0.78rem;
            color: #6b7280;
        }

        .shift-add-row select {
            font-size: 0.8rem;
            padding: 0.25rem 0.4rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background: #ffffff;
        }

        .shift-add-row button {
            font-size: 0.8rem;
            padding: 0.25rem 0.65rem;
            border-radius: 999px;
            border: none;
            background: #111827;
            color: #ffffff;
            cursor: pointer;
        }

        .shift-add-row button:hover {
            background: #1f2937;
        }

        /* Appointment section */
        .appointments-section {
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            padding: 1.1rem 1.2rem;
            background: #f9fafb;
        }

        .appointments-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.65rem;
        }

        .appointments-section-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .appointments-count {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .appointments-group-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin: 0.5rem 0 0.25rem;
            color: #4b5563;
        }

        .appointments-table-wrapper {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            overflow: hidden;
        }

        table.appointments-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .appointments-table thead {
            background: #f3f4f6;
        }

        .appointments-table th,
        .appointments-table td {
            padding: 0.45rem 0.6rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        .appointments-table th {
            font-weight: 600;
            color: #4b5563;
        }

        .appointments-table tr:last-child td {
            border-bottom: none;
        }

        .no-appointments {
            font-size: 0.8rem;
            color: #6b7280;
            padding: 0.4rem 0.2rem;
        }

        .clickable-row {
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .appointments-table th:nth-child(4),
            .appointments-table td:nth-child(4) {
                display: none;
            }
        }
    </style>
</head>
<body class="staff-layout">

<!-- Sidebar -->
<div th:replace="~{fragments/staff-sidebar :: staff-site-header}"></div>

<!-- MAIN CONTENT -->
<main class="staff-main schedule-page"
      th:attr="data-date=${#temporals.format(date, 'yyyy-MM-dd')}">
    <div class="schedule-layout-inner">
        <section class="schedule-card">

            <!-- Header -->
            <div class="schedule-header-row">
                <div class="schedule-title-block section-heading">
                    <p class="section-kicker" th:text="#{schedule.day.kicker}">Staff Scheduling</p>
                    <h2 th:text="#{schedule.day.heading}">Day Schedule</h2>
                    <p class="schedule-subtext">
                        <span th:text="#{schedule.day.subtitlePrefix}">Shift assignments and appointments for</span>
                        <span class="day-date-label"
                              th:text="${#temporals.format(date, 'EEEE, dd MMM yyyy')}">
                            Monday, 01 Jan 2025
                        </span>.
                    </p>
                </div>

                <div class="schedule-controls">
                    <a th:href="@{/manager/schedule}" class="back-link">
                        ← <span th:text="#{schedule.day.backToMonth}">Back to month view</span>
                    </a>
                </div>
            </div>

            <!-- Main grid: shifts on left, appointments on right -->
            <div class="schedule-main-grid">

                <!-- Shifts / staff section -->
                <section class="shift-section">
                    <div class="shift-section-header">
                        <div class="shift-section-title" th:text="#{schedule.day.shiftsAndStaff}">Shifts &amp; Staff</div>
                    </div>

                    <div class="shift-list"
                         th:if="${day.shifts != null and !#lists.isEmpty(day.shifts)}">

                        <!-- One block per shift (AM / PM) -->
                        <div class="shift-block"
                             th:each="shift : ${day.shifts}">
                            <div class="shift-block-header">
                                <div>
                                    <!-- AM / PM label -->
                                    <span class="shift-name-pill">
                                        <span th:text="${shift.shiftName} + ' ' + #{schedule.day.shiftSuffix}">
                                            AM shift
                                        </span>
                                    </span>

                                    <!-- Time range: prefer DTO’s timeRange; fallback to hardcoded AM/PM -->
                                    <span class="shift-time"
                                          th:text="${shift.timeRange != null ? shift.timeRange
                                : (shift.shiftName == 'AM' ? '07:30 - 12:00' : '12:30 - 19:00')}">
                                        07:30 - 12:00
                                    </span>
                                </div>
                            </div>

                            <!-- ADD STAFF FORM -->
                            <div class="shift-add-row">
                                <form th:action="@{/manager/shift/assign-staff}"
                                      method="post"
                                      style="display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap;">

                                    <!-- pass date & shiftInstanceId -->
                                    <input type="hidden" name="date"
                                           th:value="${#temporals.format(date, 'yyyy-MM-dd')}" />
                                    <input type="hidden" name="shiftInstanceId"
                                           th:value="${shift.shiftInstanceId}" />

                                    <label style="font-size:0.78rem; color:#6b7280;"
                                           th:text="#{schedule.day.addStaffLabel}">
                                        Add staff:
                                    </label>

                                    <select name="staffId" class="shift-staff-select">
                                        <option value="" th:text="#{schedule.day.selectStaffPlaceholder}">
                                            Select staff…
                                        </option>
                                        <option th:each="staff : ${allStaff}"
                                                th:value="${staff.id}"
                                                th:text="${staff.name}">
                                            Staff Name
                                        </option>
                                    </select>

                                    <button type="submit" th:text="#{schedule.day.addBtn}">Add</button>
                                </form>
                            </div>

                            <!-- Assigned staff -->
                            <div>
                                <span style="font-size: 0.8rem; color:#4b5563;"
                                      th:text="#{schedule.day.assignedStaffLabel}">
                                    Assigned staff:
                                </span>

                                <div class="shift-staff-list">
                                    <span class="staff-chip"
                                          th:each="s : ${shift.assignedStaff}">
                                        <span th:text="${s.staffName}">Staff Name</span>

                                        <!-- REMOVE STAFF FORM -->
                                        <form th:action="@{/manager/shift/remove-staff}"
                                              method="post"
                                              style="display:inline;">
                                            <input type="hidden" name="date"
                                                   th:value="${#temporals.format(date, 'yyyy-MM-dd')}" />
                                            <input type="hidden" name="shiftInstanceId"
                                                   th:value="${shift.shiftInstanceId}" />
                                            <input type="hidden" name="staffId"
                                                   th:value="${s.staffId}" />
                                            <button type="submit" th:title="#{schedule.day.removeTitle}">&times;</button>
                                        </form>
                                    </span>

                                    <span th:if="${shift.assignedStaff == null or #lists.isEmpty(shift.assignedStaff)}"
                                          style="font-size: 0.78rem; color:#9ca3af;"
                                          th:text="#{schedule.day.noStaffAssigned}">
                                        No staff assigned yet
                                    </span>
                                </div>
                            </div>

                            <!-- Suggestions -->
                            <div class="shift-suggestion"
                                 th:if="${shift.suggestedStaff != null and !#lists.isEmpty(shift.suggestedStaff)}">
                                <span th:text="#{schedule.day.suggestionsPrefix}">Suggestions:</span>
                                <span th:each="suggestion, iterStat : ${shift.suggestedStaff}">
                                    <span class="suggestion-highlight"
                                          th:text="${suggestion.staffName}">Anna</span>
                                    (<span th:text="${suggestion.preferenceCount}">0</span> <span th:text="#{schedule.day.suggestionsPrefsSuffix}">prefs</span>)
                                    <span th:if="${!iterStat.last}"> · </span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <p th:if="${day.shifts == null or #lists.isEmpty(day.shifts)}"
                       style="font-size: 0.8rem; color:#6b7280;"
                       th:text="#{schedule.day.noShifts}">
                        No shifts defined for this day yet.
                    </p>
                </section>

                <!-- Appointments section -->
                <section class="appointments-section">
                    <div class="appointments-section-header">
                        <div class="appointments-section-title" th:text="#{schedule.day.appointmentsHeading}">
                            Appointments
                        </div>
                        <div class="appointments-count">
                            <span th:text="${#lists.size(day.appointments)}">0</span>
                            <span th:text="#{schedule.day.totalSuffix}">total</span>
                        </div>
                    </div>

                    <!-- Grouped by shift -->
                    <div th:if="${day.shifts != null and !#lists.isEmpty(day.shifts)}">
                        <div th:each="shift : ${day.shifts}">
                            <h4 class="appointments-group-title"
                                th:text="${shift.shiftName} + ' ' + #{schedule.day.shiftSuffix} + ' (' + shift.timeRange + ')'">
                                AM shift (07:30 - 12:00)
                            </h4>

                            <div class="appointments-table-wrapper">
                                <table class="appointments-table">
                                    <thead>
                                    <tr>
                                        <th th:text="#{schedule.day.table.time}">Time</th>
                                        <th th:text="#{schedule.day.table.preferredStaff}">Preferred staff</th>
                                        <th th:text="#{schedule.day.table.assignedStaff}">Assigned staff</th>
                                        <th th:text="#{schedule.day.table.appointmentId}">Appointment ID</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="appt : ${day.appointments}"
                                        th:if="${appt.shiftInstanceId} == ${shift.shiftInstanceId}"
                                        class="clickable-row"
                                        th:onclick="|window.location.href='@{/staff/registration/view/{id}(id=${appt.appointmentId})}'|">
                                        <td th:text="${#temporals.format(appt.scheduledAt, 'HH:mm')}">
                                            09:30
                                        </td>
                                        <td th:text="${appt.preferredStaffName != null ? appt.preferredStaffName : '—'}">
                                            —
                                        </td>
                                        <td th:text="${appt.responsibleStaffName != null ? appt.responsibleStaffName : 'Unassigned'}">
                                            Unassigned
                                        </td>
                                        <td th:text="${appt.appointmentId}">1</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Appointments without shift (edge cases) -->
                    <div th:if="${day.appointments != null and !#lists.isEmpty(day.appointments)}">
                        <h4 class="appointments-group-title" th:text="#{schedule.day.otherAppointmentsHeading}">
                            Other / Unmapped appointments
                        </h4>
                        <div class="appointments-table-wrapper">
                            <table class="appointments-table">
                                <thead>
                                <tr>
                                    <th th:text="#{schedule.day.table.time}">Time</th>
                                    <th th:text="#{schedule.day.table.preferredStaff}">Preferred staff</th>
                                    <th th:text="#{schedule.day.table.assignedStaff}">Assigned staff</th>
                                    <th th:text="#{schedule.day.table.appointmentId}">Appointment ID</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="appt : ${day.appointments}"
                                    th:if="${appt.shiftInstanceId} == null"
                                    class="clickable-row"
                                    th:onclick="|window.location.href='@{/manager/registration/view/{id}(id=${appt.appointmentId})}'|">
                                    <td th:text="${#temporals.format(appt.scheduledAt, 'HH:mm')}">
                                        10:00
                                    </td>
                                    <td th:text="${appt.preferredStaffName != null ? appt.preferredStaffName : '—'}">
                                        —
                                    </td>
                                    <td th:text="${appt.responsibleStaffName != null ? appt.responsibleStaffName : 'Unassigned'}">
                                        Unassigned
                                    </td>
                                    <td th:text="${appt.appointmentId}">1</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <p th:if="${day.appointments == null or #lists.isEmpty(day.appointments)}"
                       class="no-appointments"
                       th:text="#{schedule.day.noAppointments}">
                        No appointments for this day.
                    </p>
                </section>

            </div>

        </section>
    </div>
</main>

</body>
</html>
