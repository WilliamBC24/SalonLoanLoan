<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Registration</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        input[type="text"], input[type="time"], input[type="date"], select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .service-list { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .service-item { padding: 5px; cursor: pointer; border-bottom: 1px solid #eee; }
        .service-item:hover { background: #f0f0f0; }
        .selected-services { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 5px; }
        .summary { margin-top: 20px; padding: 10px; background: #e0f7fa; border-radius: 5px; }
        .blocked { background: #ffcccc; cursor: not-allowed; }
        button { padding: 10px 20px; background: #3b82f6; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body>
<div class="container">
    <h1>Book an Appointment</h1>

    <label for="service-search">Search Services:</label>
    <input type="text" id="service-search" placeholder="Type to search services...">

    <div class="service-list" id="service-list">
        <!-- Services will be populated here dynamically -->
    </div>

    <div class="selected-services" id="selected-services">
        <strong>Selected Services:</strong>
        <ul id="selected-services-list"></ul>
    </div>

    <label for="appointment-date">Select Date:</label>
    <input type="date" id="appointment-date">

    <label for="appointment-time">Select Time:</label>
    <input type="time" id="appointment-time">

    <div class="summary">
        <p>Total Duration: <span id="total-duration">0</span> minutes</p>
        <p>Total Price: $<span id="total-price">0</span></p>
        <p>End Time: <span id="end-time">--:--</span></p>
    </div>

    <button id="book-appointment">Book Appointment</button>

</div>

<script>

    $(document).ready(function() {
//         let blockedDates = []; // fetched from backend
//
// // Example: fetch blocked dates on page load
//         $.ajax({
//             url: '/appointments/blocked-dates',
//             method: 'GET',
//             success: function(data) {
//                 blockedDates = data; // array of strings YYYY-MM-DD
//             }
//         });
//
//         $("#appointment-date").on("input", function() {
//             const selected = $(this).val();
//             if (blockedDates.includes(selected)) {
//                 alert("Selected date is unavailable. Please choose another date.");
//                 $(this).val("");
//             }
//         });
//         let blockedSlots = {}; // { "2025-11-05": [{start: "15:00", end: "19:00"}], ... }
//
//         $("#appointment-date").on("change", function() {
//             const date = $(this).val();
//             if (!date) return;
//
//             // Fetch blocked slots for this date
//             $.ajax({
//                 url: `/appointments/blocked-slots/${date}`,
//                 method: "GET",
//                 success: function(slots) {
//                     blockedSlots[date] = slots; // array of {start, end}
//                 }
//             });
//         });
//
//         $("#appointment-time").on("change", function() {
//             const date = $("#appointment-date").val();
//             const time = $(this).val();
//             if (!date || !time) return;
//
//             const dayBlocked = blockedSlots[date] || [];
//             for (const slot of dayBlocked) {
//                 if (time >= slot.start && time < slot.end) {
//                     alert("Selected time is unavailable. Please choose another time.");
//                     $(this).val("");
//                     return;
//                 }
//             }
//         });
//
//
        let debounceTimer;
        // here
        $("#service-search").on("input", function() {
            const query = $(this).val().trim();

            // Only search if 2+ characters
            if (query.length < 2) {
                $("#service-list").empty();
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                $.ajax({
                    url: `/services/search`,
                    method: "GET",
                    data: { query: query },
                    success: function(data) {
                        // Assume data is an array of services: [{id, name, price, duration}, ...]
                        renderServices(data);
                    },
                    error: function(err) {
                        console.error("Error fetching services", err);
                    }
                });
            }, 300); // 300ms debounce
        });
        // to here


        // Sample blocked slots from backend (date + time ranges)
        // const blockedSlots = {
        //     "2025-11-05": [{ start: "15:00", end: "19:00" }]
        // };

        let selectedServices = [];

        function renderServices(list) {
            $("#service-list").empty();
            list.forEach(s => {
                $("#service-list").append(`<div class="service-item" data-name="${s.serviceName}" data-price="${s.servicePrice}" data-duration="${s.durationMinutes}">
                ${s.serviceName} - $${s.servicePrice} - ${s.durationMinutes} min
            </div>`);
            });
        }

        // renderServices(services);

        // $("#service-search").on("input", function() {
        //     const query = $(this).val().toLowerCase();
        //     const filtered = services.filter(s => s.name.toLowerCase().includes(query));
        //     renderServices(filtered);
        // });

        $("#service-list").on("click", ".service-item", function() {
            const name = $(this).data("name");
            const price = parseFloat($(this).data("price"));
            const duration = parseInt($(this).data("duration"));

            // prevent duplicates by checking name
            if (!selectedServices.some(s => s.name === name)) {
                const service = { name, price, duration };
                selectedServices.push(service);

                $("#selected-services-list").append(`
            <li data-name="${name}">
                ${name} - $${price} - ${duration} min
                <button class="remove-service">Remove</button>
            </li>
        `);

                updateSummary();
            }
        });

        $("#selected-services-list").on("click", ".remove-service", function() {
            const li = $(this).closest("li");
            const serviceId = parseInt(li.data("id"));
            selectedServices = selectedServices.filter(s => s.id !== serviceId);
            li.remove();
            updateSummary();
        });

        function updateSummary() {
            const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const totalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);
            $("#total-duration").text(totalDuration);
            $("#total-price").text(totalPrice);
            updateEndTime();
        }

        function updateEndTime() {
            const startTime = $("#appointment-time").val();
            if (!startTime || selectedServices.length === 0) {
                $("#end-time").text("--:--");
                return;
            }
            const totalMinutes = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const [hours, minutes] = startTime.split(":").map(Number);
            let date = new Date();
            date.setHours(hours, minutes);
            date.setMinutes(date.getMinutes() + totalMinutes);

            const endHours = date.getHours().toString().padStart(2, "0");
            const endMinutes = date.getMinutes().toString().padStart(2, "0");
            $("#end-time").text(`${endHours}:${endMinutes}`);
        }

        $("#appointment-time, #appointment-date").on("change", function() {
            const date = $("#appointment-date").val();
            const time = $("#appointment-time").val();
            if (!date || !time) return;

            const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const [hours, minutes] = time.split(":").map(Number);
            let startDateTime = new Date(`${date}T${time}`);
            let endDateTime = new Date(startDateTime);
            endDateTime.setMinutes(endDateTime.getMinutes() + totalDuration);

            // Check if appointment goes beyond closing time (19:00)
            const closingTime = new Date(`${date}T19:00`);
            if (endDateTime > closingTime) {
                alert("Selected services exceed closing time. Please pick an earlier time or fewer services.");
                $("#appointment-time").val("");
                $("#end-time").text("--:--");
                return;
            }

            // Check against blocked slots
            // const dayBlocked = blockedSlots[date] || [];
            // for (const slot of dayBlocked) {
            //     const blockStart = new Date(`${date}T${slot.start}`);
            //     const blockEnd = new Date(`${date}T${slot.end}`);
            //     if (startDateTime < blockEnd && endDateTime > blockStart) {
            //         alert("Selected time overlaps with a blocked slot. Please choose another time.");
            //         $("#appointment-time").val("");
            //         $("#end-time").text("--:--");
            //         return;
            //     }
            // }

            updateEndTime();
        });

        $("#book-appointment").on("click", function() {
            const date = $("#appointment-date").val();
            const time = $("#appointment-time").val();
            if (!date || !time || selectedServices.length === 0) {
                alert("Please select services, date, and time.");
                return;
            }
            alert("Appointment booked successfully!");
            // Here you would send data to backend
        });
    });
</script>

</body>
</html>
