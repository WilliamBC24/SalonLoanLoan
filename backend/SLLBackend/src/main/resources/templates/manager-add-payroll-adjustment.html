<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title th:text="#{payroll.staffDetail.pageTitle}">Manager - Staff Payroll Detail | Salon Loan Loan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Global layout + styles -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <style>
        /* ===== PAGE STRUCTURE ===== */
        .staff-payroll-page {
            padding: 2.5rem 0 3rem;
            background: var(--bg-light);
            min-height: 100vh;
        }

        .staff-payroll-layout-inner {
            max-width: 80vw;
            width: 100%;
            margin: 1rem auto;
        }

        .staff-payroll-card {
            background: #ffffff;
            padding: 2.2rem;
            border-radius: var(--radius-lg);
            border: 1px solid #e5e7eb;
            box-shadow: var(--shadow-soft);
        }

        /* ===== HEADER ROW ===== */
        .staff-payroll-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .staff-payroll-title-block {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .staff-name-line {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .staff-meta-line {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .staff-payroll-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .month-year-form {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.85rem;
        }

        .month-year-form select {
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            font-size: 0.85rem;
        }

        .month-year-form button {
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .month-year-form button:hover {
            background: #eef2ff;
        }

        .back-link-pill {
            border-radius: 999px;
            padding: 0.35rem 0.9rem;
            border: 1px solid #d1d5db;
            background: #ffffff;
            font-size: 0.82rem;
            text-decoration: none;
            color: #374151;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .back-link-pill:hover {
            background: #f3f4f6;
        }

        /* ===== SUMMARY STRIP ===== */
        .staff-payroll-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .summary-chip {
            display: inline-flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .summary-chip-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b7280;
        }

        .summary-chip-value {
            font-weight: 600;
        }

        .summary-chip-value.positive {
            color: #15803d;
        }

        .summary-chip-value.negative {
            color: #b91c1c;
        }

        /* ===== ADJUSTMENTS HEADER + BUTTON ===== */
        .adjustments-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.8rem;
        }

        .adjustments-header-row h3 {
            margin: 0;
            font-size: 1rem;
        }

        .adjustments-header-sub {
            font-size: 0.82rem;
            color: #6b7280;
        }

        .btn-primary-sm {
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: none;
            background: var(--accent, #4f46e5);
            color: #ffffff;
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-primary-sm:hover {
            filter: brightness(0.95);
        }

        /* ===== ADJUSTMENTS TABLE ===== */
        .adjustments-table-wrapper {
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .adjustments-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
        }

        .adjustments-table thead {
            background: #f9fafb;
        }

        .adjustments-table th,
        .adjustments-table td {
            padding: 0.65rem 0.9rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        .adjustments-table th {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #6b7280;
        }

        .adjustments-table tbody tr:last-child td {
            border-bottom: none;
        }

        .no-data-row {
            text-align: center;
            color: #9ca3af;
            font-size: 0.88rem;
        }

        .amount-cell {
            text-align: right;
            white-space: nowrap;
            font-variant-numeric: tabular-nums;
        }

        .tbadge {
            display: inline-flex;
            align-items: center;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
        }

        .tbadge-bonus {
            background: #ecfdf5;
            color: #166534;
        }

        .tbadge-deduction {
            background: #fef2f2;
            color: #b91c1c;
        }

        /* ===== MODAL ===== */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal-card {
            background: #ffffff;
            border-radius: 18px;
            padding: 1.8rem 1.6rem 1.4rem;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .modal-close-btn {
            border: none;
            background: transparent;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .modal-field-label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.1rem;
        }

        .modal-select,
        .modal-input,
        .modal-textarea {
            width: 100%;
            padding: 0.48rem 0.7rem;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            font-size: 0.87rem;
        }

        .modal-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.6rem;
        }

        .btn-secondary-sm {
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-secondary-sm:hover {
            background: #e5e7eb;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            .staff-payroll-layout-inner {
                max-width: 95vw;
            }

            .staff-payroll-card {
                padding: 1.7rem 1.4rem;
            }

            .staff-payroll-header-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .staff-payroll-controls {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body class="staff-layout">

<!-- Manager / staff sidebar -->
<div th:replace="~{fragments/staff-sidebar :: staff-site-header}"></div>

<!-- MAIN CONTENT -->
<main class="staff-main staff-payroll-page">
    <div class="staff-payroll-layout-inner">
        <section class="staff-payroll-card">

            <!-- HEADER -->
            <div class="staff-payroll-header-row">
                <div class="staff-payroll-title-block section-heading">
                    <p class="section-kicker" th:text="#{payroll.staffDetail.kicker}">Manager View</p>
                    <h2 th:text="#{payroll.staffDetail.title}">Staff Payroll Detail</h2>

                    <div class="staff-name-line">
                        <span th:text="${staffName}">Nguyen Van A</span>
                    </div>
                    <div class="staff-meta-line">
                        <span th:text="${positionName != null ? positionName : #{payroll.staffDetail.noPosition}}">Senior Stylist</span>
                        ·
                        <span th:text="${currentMonthLabel}">March 2025</span>
                    </div>
                </div>

                <div class="staff-payroll-controls">
                    <!-- Back to main payroll list -->
                    <a th:href="@{/manager/payroll}" class="back-link-pill">
                        <span>←</span>
                        <span th:text="#{payroll.staffDetail.backToPayroll}">Back to Payroll</span>
                    </a>

                    <!-- Month / year selector -->
                    <form th:action="@{'/manager/payroll/staff/' + ${staffId}}" method="get" class="month-year-form">

                        <label for="monthSelect" th:text="#{payroll.staffDetail.monthLabel}">Month:</label>
                        <select id="monthSelect" name="month">
                            <option th:each="m : ${monthOptions}"
                                    th:value="${m}"
                                    th:selected="${m == selectedMonth}"
                                    th:text="${m}">
                                1
                            </option>
                        </select>

                        <label for="yearSelect" th:text="#{payroll.staffDetail.yearLabel}">Year:</label>
                        <select id="yearSelect" name="year">
                            <option th:each="y : ${yearOptions}"
                                    th:value="${y}"
                                    th:selected="${y == selectedYear}"
                                    th:text="${y}">
                                2025
                            </option>
                        </select>

                        <button type="submit" th:text="#{payroll.staffDetail.goBtn}">Go</button>
                    </form>
                </div>
            </div>

            <!-- SUMMARY STRIP -->
            <div class="staff-payroll-summary">
                <div class="summary-chip">
                    <span class="summary-chip-label" th:text="#{payroll.staffDetail.summary.baseSalary}">Base Salary</span>
                    <span class="summary-chip-value"
                          th:text="${#numbers.formatInteger(payrollRow.baseSalary, 3, 'COMMA')} + ' VND'">
                        0 VND
                    </span>
                </div>

                <div class="summary-chip">
                    <span class="summary-chip-label" th:text="#{payroll.staffDetail.summary.commission}">Commission</span>
                    <span class="summary-chip-value positive"
                          th:text="${#numbers.formatInteger(payrollRow.commissionAmount, 3, 'COMMA')} + ' VND'">
                        0 VND
                    </span>
                </div>

                <div class="summary-chip">
                    <span class="summary-chip-label" th:text="#{payroll.staffDetail.summary.bonusAdjustments}">Bonus Adjustments</span>
                    <span class="summary-chip-value positive"
                          th:text="${#numbers.formatInteger(payrollRow.bonusAmount, 3, 'COMMA')} + ' VND'">
                        0 VND
                    </span>
                </div>

                <div class="summary-chip">
                    <span class="summary-chip-label" th:text="#{payroll.staffDetail.summary.deductionAdjustments}">Deduction Adjustments</span>
                    <span class="summary-chip-value negative"
                          th:text="${#numbers.formatInteger(payrollRow.deductionsAmount, 3, 'COMMA')} + ' VND'">
                        0 VND
                    </span>
                </div>

                <div class="summary-chip">
                    <span class="summary-chip-label" th:text="#{payroll.staffDetail.summary.netPay}">Net Pay</span>
                    <span class="summary-chip-value"
                          th:classappend="${payrollRow.totalPay < 0} ? ' negative' : ' positive'"
                          th:text="${#numbers.formatInteger(payrollRow.totalPay, 3, 'COMMA')} + ' VND'">
                        0 VND
                    </span>
                </div>
            </div>

            <!-- ADJUSTMENTS LIST -->
            <div class="adjustments-header-row">
                <div>
                    <h3 th:text="#{payroll.staffDetail.adjustments.title}">Payroll Adjustments</h3>
                    <div class="adjustments-header-sub" th:text="#{payroll.staffDetail.adjustments.subtitle}">
                        Bonuses and deductions applied in this month.
                    </div>
                </div>

                <button type="button"
                        class="btn-primary-sm"
                        id="openAdjustmentModalBtn">
                    <span>＋</span>
                    <span th:text="#{payroll.staffDetail.adjustments.newBtn}">New Adjustment</span>
                </button>
            </div>

            <div class="adjustments-table-wrapper">
                <table class="adjustments-table">
                    <thead>
                    <tr>
                        <th th:text="#{payroll.staffDetail.adjustments.table.date}">Date</th>
                        <th th:text="#{payroll.staffDetail.adjustments.table.type}">Type</th>
                        <th class="amount-cell" th:text="#{payroll.staffDetail.adjustments.table.amount}">Amount</th>
                        <th th:text="#{payroll.staffDetail.adjustments.table.note}">Note</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(adjustments)}">
                        <td colspan="4" class="no-data-row">
                            <span th:text="#{payroll.staffDetail.adjustments.empty}">No adjustments for this period.</span>
                        </td>
                    </tr>

                    <tr th:each="adj : ${adjustments}">
                        <td th:text="${adj.effectiveDate}">2025-03-01</td>
                        <td>
                            <span th:switch="${adj.adjustmentType.name()}">
                                <span th:case="'BONUS'"
                                      class="tbadge tbadge-bonus"
                                      th:text="#{payroll.staffDetail.adjustments.type.bonus}">Bonus</span>
                                <span th:case="'DEDUCTION'"
                                      class="tbadge tbadge-deduction"
                                      th:text="#{payroll.staffDetail.adjustments.type.deduction}">Deduction</span>
                                <span th:case="*"
                                      class="tbadge"
                                      th:text="#{payroll.staffDetail.adjustments.type.unknown}">Unknown</span>
                            </span>
                        </td>
                        <td class="amount-cell"
                            th:classappend="${adj.adjustmentType.name() == 'DEDUCTION'} ? ' money-negative' : ' money-positive'"
                            th:text="${#numbers.formatInteger(adj.amount, 3, 'COMMA')} + ' VND'">
                            0 VND
                        </td>
                        <td th:text="${adj.note != null ? adj.note : #{payroll.staffDetail.adjustments.noNote}}">
                            —
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </section>
    </div>
</main>

<!-- MODAL: CREATE ADJUSTMENT -->
<div class="modal-backdrop" id="adjustmentModal">
    <div class="modal-card">
        <div class="modal-header">
            <h3 th:text="#{payroll.staffDetail.modal.title}">New Payroll Adjustment</h3>
            <button type="button" class="modal-close-btn" id="closeAdjustmentModalBtn">×</button>
        </div>

        <form th:action="@{/manager/payroll/adjustment/create}" method="post">
            <div class="modal-body">

                <!-- Staff ID -->
                <input type="hidden" name="staffId" th:value="${staffId}" />

                <div>
                    <label class="modal-field-label" for="adjustmentType" th:text="#{payroll.staffDetail.modal.typeLabel}">Adjustment Type</label>
                    <select id="adjustmentType" name="adjustmentType" class="modal-select" required>
                        <option value="" disabled selected th:text="#{payroll.staffDetail.modal.typePlaceholder}">Select type…</option>
                        <option value="BONUS" th:text="#{payroll.staffDetail.modal.typeBonus}">Bonus</option>
                        <option value="DEDUCTION" th:text="#{payroll.staffDetail.modal.typeDeduction}">Deduction</option>
                    </select>
                </div>

                <div>
                    <label class="modal-field-label" for="amount" th:text="#{payroll.staffDetail.modal.amountLabel}">Amount (VND)</label>
                    <input id="amount"
                           name="amount"
                           type="number"
                           min="1"
                           class="modal-input"
                           th:placeholder="#{payroll.staffDetail.modal.amountPlaceholder}"
                           placeholder="Enter amount…"
                           required />
                    <small style="font-size: 0.78rem; color: #6b7280;"
                           th:text="#{payroll.staffDetail.modal.amountHelp}">
                        Positive value only; backend will treat BONUS as + and DEDUCTION as − in payroll calculation.
                    </small>
                </div>

                <div>
                    <label class="modal-field-label" for="note" th:text="#{payroll.staffDetail.modal.noteLabel}">Note (optional)</label>
                    <textarea id="note"
                              name="note"
                              class="modal-textarea"
                              th:placeholder="#{payroll.staffDetail.modal.notePlaceholder}"
                              placeholder="E.g. performance bonus, late arrival, etc."></textarea>
                </div>
            </div>
            <input type="hidden" name="month" th:value="${selectedMonth}">
            <input type="hidden" name="year" th:value="${selectedYear}">

            <div class="modal-footer">
                <button type="button" class="btn-secondary-sm" id="cancelAdjustmentBtn"
                        th:text="#{payroll.staffDetail.modal.cancelBtn}">
                    Cancel
                </button>
                <button type="submit" class="btn-primary-sm"
                        th:text="#{payroll.staffDetail.modal.saveBtn}">
                    Save Adjustment
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    $(function () {
        const $modal = $('#adjustmentModal');
        const openBtn = $('#openAdjustmentModalBtn');
        const closeBtn = $('#closeAdjustmentModalBtn');
        const cancelBtn = $('#cancelAdjustmentBtn');

        function openModal() {
            $modal.addClass('active');
        }

        function closeModal() {
            $modal.removeClass('active');
        }

        openBtn.on('click', openModal);
        closeBtn.on('click', closeModal);
        cancelBtn.on('click', closeModal);

        // Close when clicking backdrop
        $modal.on('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });
    });
</script>

</body>
</html>
