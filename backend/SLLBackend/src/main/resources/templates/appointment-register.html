<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment | Salon Loan Loan</title>

    <!-- Global Styles -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <style>
        /* Page layout card */
        .appointment-wrapper {
            background: #ffffff;
            padding: 2.5rem;
            border-radius: 24px;
            border: 1px solid #e6e6e6;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.05);
            max-width: 900px;
            margin: 2rem auto;
        }

        /* Inputs */
        .form-input {
            width: 100%;
            padding: 0.85rem 1.1rem;
            border: 1px solid #d0d0d0;
            border-radius: 999px;
            font-size: 0.95rem;
            transition: border .2s, box-shadow .2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255,132,0,0.25);
        }

        /* Service search list */
        .service-list {
            max-height: 200px;
            overflow-y: auto;
            border-radius: 16px;
            border: 1px solid #e6e6e6;
            background: #fafafa;
            margin-bottom: 1rem;
        }
        .service-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .service-item:hover {
            background: #f3f3f3;
        }

        /* Selected services */
        .selected-services {
            background: #f7f7fe;
            border: 1px solid #dcdcff;
            padding: 1rem 1.2rem;
            border-radius: 16px;
            margin-top: 1.5rem;
        }
        .selected-services ul {
            list-style: none;
            padding-left: 0;
            margin: 0.5rem 0 0;
        }
        .selected-services li {
            display: flex;
            justify-content: space-between;
            padding: 0.45rem 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .selected-services button {
            background: transparent;
            border: none;
            color: #d33;
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* Summary card */
        .summary {
            margin-top: 2rem;
            background: #fff9e8;
            border: 1px solid #ffe6b0;
            padding: 1.2rem 1.4rem;
            border-radius: 16px;
            font-size: 0.95rem;
        }

        /* Section labels */
        .form-label {
            margin-top: 1rem;
            font-weight: 600;
            font-size: 0.95rem;
            display: block;
        }

        /* Error (old global, now mostly unused) */
        #error {
            margin-top: 0.8rem;
            color: #d00;
            font-weight: 600;
        }

        /* Field-level notes / warnings */
        .field-note {
            margin-top: 0.35rem;
            font-size: 0.85rem;
            color: #d97706; /* amber-ish for warnings */
        }
        .field-note.error {
            color: #dc2626; /* red for hard errors */
        }

        @media (max-width: 768px) {
            .appointment-wrapper {
                padding: 1.8rem;
            }
        }
        .message {
            margin-top: 1.6rem;
            padding: 1rem 1.3rem;
            border-radius: 16px;
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
        }

        .message.success {
            background: #e8fff0;
            border: 1px solid #b2e5c4;
            color: #0f8a3b;
        }

        .message.error {
            background: #ffecec;
            border: 1px solid #ffb3b3;
            color: #b30000;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>

<body>

<!-- HEADER -->
<div th:replace="~{fragments/header :: site-header}"></div>

<main>
    <div class="appointment-wrapper container">

        <div class="section-heading text-center">
            <p class="section-kicker">Book Now</p>
            <h2>Appointment Registration</h2>
        </div>
        <div th:if="${param.error}" class="message error">Invalid inputs</div>
        <div th:if="${param.success}" class="message success">Registered successfully</div>

        <h2 id="error"></h2>

        <form th:action="@{/appointment/book}" method="post" id="appointment-form">

            <!-- SERVICE SEARCH -->
            <label for="service-search" class="form-label">Search Services</label>
            <input type="text" id="service-search" class="form-input" placeholder="Type to search services...">

            <div class="service-list" id="service-list"></div>

            <!-- SELECTED SERVICES LIST -->
            <div class="selected-services">
                <strong>Selected Services:</strong>
                <ul id="selected-services-list"></ul>
                <input type="hidden" id="selected-services-input" name="selectedServices">
            </div>

            <!-- CUSTOMER INFO -->
            <label for="customer-name" class="form-label">Full Name</label>
            <input type="text"
                   id="customer-name"
                   name="name"
                   class="form-input"
                   th:value="${username != null ? username : ''}"
                   th:readonly="${username != null}"
                   placeholder="Enter your name"
                   required>

            <label for="phone-number" class="form-label">Phone Number</label>
            <input type="tel" id="phone-number" name="phoneNumber" class="form-input"
                   th:value="${phoneNumber}" placeholder="Enter your phone number">

            <!-- DATE & TIME -->
            <label for="appointment-date" class="form-label">Date</label>
            <input type="date" id="appointment-date" name="appointmentDate" class="form-input"
                   th:value="${appointmentDate}" required>
            <div id="date-warning" class="field-note"></div>


            <label for="appointment-time" class="form-label">Time</label>
            <input type="time" id="appointment-time" name="appointmentTime" class="form-input"
                   th:value="${appointmentTime}" required>
            <div id="time-warning" class="field-note"></div>

            <!-- SUMMARY -->
            <div class="summary">
                <p>Estimated Duration: <strong><span id="total-duration">0</span> min</strong></p>
                <input type="hidden" id="total-duration-input" name="totalDuration" th:value="${totalDuration}">

                <p>Estimated Price: <strong>₫<span id="total-price">0</span></strong></p>
                <input type="hidden" id="total-price-input" name="totalPrice" th:value="${totalPrice}">

                <p>End Time: <strong><span id="end-time">--:--</span></strong></p>
                <input type="hidden" id="end-time-input" name="endTime" th:value="${endTime}">
                <div id="end-time-warning" class="field-note"></div>
            </div>

            <button type="submit" class="btn-primary" id="submit-btn"
                    style="margin-top: 1.8rem; width: 100%;">
                Book Appointment
            </button>

        </form>

        <!-- Messages -->
    </div>
</main>

<!-- FOOTER -->
<div th:replace="~{fragments/footer :: site-footer}"></div>

<script>
    $(document).ready(function() {
        let debounceTimer;
        let selectedServices = [];
        let selectedServicesId = [];
        let submitBlocked = false;
        const $submitBtn = $("#submit-btn");

        function updateSubmitState() {
            if (submitBlocked) {
                $submitBtn.prop("disabled", true);
            } else {
                $submitBtn.prop("disabled", false);
            }
        }

        $("#service-search").on("input", function() {
            const query = $(this).val().trim();

            // Only search if 2+ characters
            if (query.length < 2) {
                $("#service-list").empty();
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                $.ajax({
                    url: `/services/search`,
                    method: "GET",
                    data: { query: query },
                    success: function(data) {
                        // Assume data is an array of services: [{id, serviceName, servicePrice, durationMinutes}, ...]
                        renderServices(data);
                    },
                    error: function(err) {
                        console.error("Error fetching services", err);
                    }
                });
            }, 300); // 300ms debounce
        });

        function renderServices(list) {
            $("#service-list").empty();
            list.forEach(s => {
                $("#service-list").append(`
                    <div class="service-item"
                         data-id="${s.id}"
                         data-name="${s.serviceName}"
                         data-price="${s.servicePrice}"
                         data-duration="${s.durationMinutes}">
                        ${s.serviceName} - ₫${s.servicePrice} - ${s.durationMinutes} min
                    </div>
                `);
            });
        }

        $("#service-list").on("click", ".service-item", function() {
            const id = parseInt($(this).data("id"));
            const name = $(this).data("name");
            const price = parseFloat($(this).data("price"));
            const duration = parseInt($(this).data("duration"));

            // prevent duplicates by checking id
            if (!selectedServices.some(s => s.id === id)) {
                const service = { id, name, price, duration };
                selectedServices.push(service);
                selectedServicesId.push(service.id);

                $("#selected-services-list").append(`
                    <li data-id="${id}" data-name="${name}">
                        ${name} - ₫${price} - ${duration} min
                        <button class="remove-service">Remove</button>
                    </li>
                `);
                updateSummary();
                updateSelectedServicesInput();
            }
        });

        $("#selected-services-list").on("click", ".remove-service", function() {
            const li = $(this).closest("li");
            const serviceId = li.data("id");
            selectedServices = selectedServices.filter(s => s.id !== serviceId);
            selectedServicesId = selectedServicesId.filter(id => id !== serviceId);
            li.remove();
            updateSummary();
            updateSelectedServicesInput();
        });

        function updateSummary() {
            const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const totalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);

            $("#total-duration").text(totalDuration);
            $("#total-price").text(totalPrice);
            $("#total-duration-input").val(totalDuration);
            $("#total-price-input").val(totalPrice);

            updateEndTime();
        }

        function updateEndTime() {
            const startTime = $("#appointment-time").val();
            if (!startTime || selectedServices.length === 0) {
                $("#end-time").text("--:--");
                $("#end-time-input").val("");
                $("#end-time-warning").text("").removeClass("error");
                validateTimes();
                return;
            }

            const totalMinutes = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const [hours, minutes] = startTime.split(":").map(Number);
            let date = new Date();
            date.setHours(hours, minutes, 0, 0);
            date.setMinutes(date.getMinutes() + totalMinutes);

            const endHours = date.getHours().toString().padStart(2, "0");
            const endMinutes = date.getMinutes().toString().padStart(2, "0");
            const endTimeStr = `${endHours}:${endMinutes}`;

            $("#end-time").text(endTimeStr);
            $("#end-time-input").val(endTimeStr);

            validateTimes();
        }

        function validateTimes() {
            submitBlocked = false;
            $("#time-warning").text("").removeClass("error");
            $("#end-time-warning").text("").removeClass("error");
            $("#date-warning").text("").removeClass("error");

            const startTime = $("#appointment-time").val();
            if (startTime) {
                const [h, m] = startTime.split(":").map(Number);
                const minutesFromMidnight = h * 60 + m;
                const fiveThirty = 5 * 60 + 30;   // 05:30
                const sevenThirty = 7 * 60 + 30;  // 07:30

                if (minutesFromMidnight < fiveThirty) {
                    $("#time-warning")
                        .text("Appointments before 05:30 cannot be booked.")
                        .addClass("error");
                    submitBlocked = true;
                } else if (minutesFromMidnight < sevenThirty) {
                    $("#time-warning")
                        .text("Appointments before 07:30 will incur an overcharge.");
                }
            }

            const endTimeStr = $("#end-time-input").val();
            if (endTimeStr) {
                const [eh, em] = endTimeStr.split(":").map(Number);
                const endMinutes = eh * 60 + em;
                const closingMinutes = 19 * 60;       // 19:00
                const lastLegalMinutes = 23 * 60 + 59; // 23:59

                if (endMinutes > lastLegalMinutes) {
                    $("#end-time-warning")
                        .text("Appointments ending after 23:59 cannot be booked.")
                        .addClass("error");
                    submitBlocked = true;
                } else if (endMinutes > closingMinutes) {
                    $("#end-time-warning")
                        .text("Appointments ending after 19:00 will incur an overcharge.");
                }
            }
            const dateStr = $("#appointment-date").val();
            if (dateStr) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const selectedDate = new Date(dateStr + "T00:00:00");
                if (selectedDate <= today) {
                    $("#date-warning")
                        .text("Please choose a future date for your appointment.")
                        .addClass("error");
                    submitBlocked = true;
                }
            }

            updateSubmitState();
        }

        $("#appointment-time, #appointment-date").on("change", function() {
            // date change is relevant for backend, but our validation is purely time-based
            updateEndTime();
            validateTimes();
        });

        function updateSelectedServicesInput() {
            $("#selected-services-input").val(selectedServicesId.join(","));
        }

        // Final guard on submit
        $("#appointment-form").on("submit", function(e) {
            validateTimes();
            if (submitBlocked) {
                e.preventDefault();
            }
        });
    });
</script>

</body>
</html>
