<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title>Manager - Edit Service | Salon Loan Loan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Global styles (sidebar + staff-main scroll behaviour) -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <style>
        /* ===== PAGE STRUCTURE ===== */
        .service-edit-page {
            padding: 2.5rem 0 3rem;
            background: var(--bg-light);
            min-height: 100vh;
        }

        .service-edit-layout-inner {
            max-width: 70vw;
            width: 100%;
            margin: 1rem auto;
        }

        .service-edit-card {
            background: #ffffff;
            padding: 2.2rem;
            border-radius: var(--radius-lg);
            border: 1px solid #e8e8e8;
            box-shadow: var(--shadow-soft);
        }

        .service-edit-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .service-edit-title-block {
            text-align: left;
        }

        .service-edit-title-block .section-kicker {
            margin-bottom: 0.25rem;
        }

        .service-edit-title-block h2 {
            margin: 0;
            display: flex;
            align-items: baseline;
            gap: 0.4rem;
        }

        .service-id-badge {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6b7280;
        }

        .service-edit-actions {
            display: flex;
            gap: 0.6rem;
            align-items: center;
        }

        .back-link-pill {
            font-size: 0.8rem;
            border-radius: 999px;
            border: 1px solid #d0d0d0;
            padding: 0.4rem 0.9rem;
            background: #ffffff;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            text-decoration: none;
            color: var(--text-main);
        }

        .back-link-pill span.icon {
            font-size: 1.05rem;
            line-height: 1;
        }

        .back-link-pill:hover {
            background: #f4f4f4;
        }

        .info-text {
            color: #6b7280;
            font-size: 0.85rem;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 0.7rem 0.9rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .alert-error {
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }

        /* ===== FORM ===== */
        .form-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr);
            gap: 1.2rem;
            margin-top: 0.4rem;
        }

        .form-group {
            margin-bottom: 0.3rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #374151;
        }

        .required::after {
            content: " *";
            color: #dc2626;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.55rem 0.7rem;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 0.9rem;
            background: #fafafa;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 110px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-soft);
            box-shadow: 0 0 0 1px rgba(100, 179, 255, 0.35);
            background: #ffffff;
        }

        .form-group .error {
            color: #dc2626;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .form-group .warning {
            color: #92400e;
            background-color: #fffbeb;
            border: 1px solid #fef3c7;
            font-size: 0.8rem;
            display: none;
            margin-top: 0.35rem;
            padding: 0.45rem 0.6rem;
            border-radius: 8px;
        }

        .form-group input.invalid,
        .form-group select.invalid {
            border-color: #dc2626;
        }

        .checkbox-group {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.9rem;
            color: #374151;
        }

        .checkbox-group input {
            width: auto;
            margin: 0;
        }

        /* ===== BUTTONS ===== */
        .button-group {
            margin-top: 1.8rem;
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.55rem 1.2rem;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
        }

        .btn-primary {
            background: #2563eb;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #ffffff;
            color: #111827;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }
    </style>
</head>
<body class="staff-layout">

<!-- Sidebar -->
<div th:replace="~{fragments/staff-sidebar :: staff-site-header}"></div>

<!-- MAIN SCROLLABLE CONTENT -->
<main class="staff-main service-edit-page">
    <div class="service-edit-layout-inner">
        <section class="service-edit-card">
            <!-- Header -->
            <div class="service-edit-header-row">
                <div class="service-edit-title-block section-heading">
                    <p class="section-kicker">Service Management</p>
                    <h2>
                        Edit Service
                        <span class="service-id-badge">
                            #<span th:text="${service.id}">1</span>
                        </span>
                    </h2>
                    <p class="info-text">
                        You can update service information and availability here.
                    </p>
                </div>
                <div class="service-edit-actions">
                    <a href="/manager/service/list" class="back-link-pill">
                        <span class="icon">←</span>
                        <span>Back to Service List</span>
                    </a>
                </div>
            </div>

            <!-- Error Messages -->
            <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

            <!-- Form -->
            <form id="editServiceForm"
                  method="post"
                  th:action="@{/manager/service/edit/{id}(id=${service.id})}"
                  enctype="multipart/form-data"
                  class="form-grid">
                <div>
                    <div class="form-group">
                        <label for="serviceName" class="required">Service Name</label>
                        <input type="text"
                               id="serviceName"
                               name="serviceName"
                               th:value="${service.serviceName}"
                               data-original-name="${service.serviceName}"
                               required>
                        <div class="error" id="serviceNameError">Service name is required</div>
                        <div class="warning" id="serviceNameWarning">
                            A service with this name already exists
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="serviceCategoryId" class="required">Service Category</label>
                        <select id="serviceCategoryId" name="serviceCategoryId" required>
                            <option value="">-- Select Category --</option>
                            <option th:each="category : ${categories}"
                                    th:value="${category.id}"
                                    th:text="${category.name}"
                                    th:selected="${service.serviceCategory.id == category.id}">
                                Category
                            </option>
                        </select>
                        <div class="error" id="serviceCategoryIdError">
                            Service category is required
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="serviceType" class="required">Service Type</label>
                        <select id="serviceType" name="serviceType" required>
                            <option value="">-- Select Type --</option>
                            <option value="SINGLE" th:selected="${service.serviceType.name() == 'SINGLE'}">Single</option>
                            <option value="COMBO" th:selected="${service.serviceType.name() == 'COMBO'}">Combo</option>
                        </select>
                        <div class="error" id="serviceTypeError">
                            Service type is required
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="servicePrice" class="required">Service Price (VND)</label>
                        <input type="number"
                               id="servicePrice"
                               name="servicePrice"
                               min="0"
                               th:value="${service.servicePrice}"
                               required>
                        <div class="error" id="servicePriceError">
                            Service price is required and must be a positive number
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="durationMinutes" class="required">Duration (minutes)</label>
                        <input type="number"
                               id="durationMinutes"
                               name="durationMinutes"
                               min="1"
                               max="32767"
                               th:value="${service.durationMinutes}"
                               required>
                        <div class="error" id="durationMinutesError">
                            Duration is required and must be between 1 and 32767 minutes
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="serviceDescription">Service Description</label>
                        <textarea id="serviceDescription"
                                  name="serviceDescription"
                                  th:text="${service.serviceDescription}"></textarea>
                    </div>

                    <!-- Existing Images -->
                    <div class="form-group" th:if="${existingImages != null && !existingImages.isEmpty()}">
                        <label>Current Images</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 0.5rem;">
                            <div th:each="image : ${existingImages}" 
                                 style="position: relative; width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb;">
                                <img th:src="@{'/images/' + ${image.imagePath}}"
                                     alt="Service image"
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     onerror="this.parentElement.style.display='none'">
                                <label style="position: absolute; top: 4px; right: 4px; background: rgba(255,255,255,0.9); border-radius: 4px; padding: 2px 4px; font-size: 0.7rem; cursor: pointer;">
                                    <input type="checkbox" th:name="deleteImageIds" th:value="${image.id}" style="margin-right: 2px;">
                                    Delete
                                </label>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.4rem;">
                            Check the images you want to delete
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="images">Add New Images</label>
                        <input type="file" id="images" name="images" multiple accept="image/jpeg,image/png,image/gif,image/webp">
                        <div class="help-text" style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                            Allowed formats: JPEG, PNG, GIF, WEBP. Max size: 5MB per image.
                        </div>
                        <div id="imagePreview" class="image-preview-container" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox"
                                   id="activeStatus"
                                   name="activeStatus"
                                   value="true"
                                   th:checked="${service.activeStatus}">
                            <label for="activeStatus">Active Status</label>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">
                            <span>Update Service</span>
                        </button>
                        <button type="button"
                                class="btn btn-secondary"
                                onclick="window.location.href='/manager/service/list'">
                            <span>✕</span>
                            <span>Cancel</span>
                        </button>
                    </div>
                </div>
            </form>
        </section>
    </div>
</main>

<script>
    let serviceNameCheckTimeout;
    let isDuplicateName = false;
    const originalServiceName = document
        .getElementById('serviceName')
        .getAttribute('data-original-name');

    // Check for duplicate service name
    function checkDuplicateServiceName(serviceName) {
        if (!serviceName || !serviceName.trim()) {
            document.getElementById('serviceNameWarning').style.display = 'none';
            isDuplicateName = false;
            return;
        }

        // Don't check if name hasn't changed
        if (serviceName.trim().toLowerCase() === originalServiceName.toLowerCase()) {
            document.getElementById('serviceNameWarning').style.display = 'none';
            isDuplicateName = false;
            return;
        }

        fetch('/services?name=' + encodeURIComponent(serviceName.trim()))
            .then(response => response.text())
            .then(html => {
                // Parse the response to check if any services exist with exact name match (case-insensitive)
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const serviceElements = doc.querySelectorAll('[data-service-name]');

                let hasExactMatch = false;
                serviceElements.forEach(elem => {
                    const existingName = elem.getAttribute('data-service-name');
                    if (existingName && existingName.toLowerCase() === serviceName.trim().toLowerCase()) {
                        hasExactMatch = true;
                    }
                });

                const warningElement = document.getElementById('serviceNameWarning');
                if (hasExactMatch) {
                    warningElement.style.display = 'block';
                    isDuplicateName = true;
                } else {
                    warningElement.style.display = 'none';
                    isDuplicateName = false;
                }
            })
            .catch(error => {
                console.error('Error checking duplicate name:', error);
            });
    }

    document.getElementById('editServiceForm').addEventListener('submit', function(event) {
        let isValid = true;

        // Check for duplicate name
        if (isDuplicateName) {
            alert('A service with this name already exists. Please choose a different name.');
            event.preventDefault();
            return;
        }

        // Validate service name
        const serviceName = document.getElementById('serviceName');
        const serviceNameError = document.getElementById('serviceNameError');
        if (!serviceName.value.trim()) {
            serviceName.classList.add('invalid');
            serviceNameError.style.display = 'block';
            isValid = false;
        } else {
            serviceName.classList.remove('invalid');
            serviceNameError.style.display = 'none';
        }

        // Validate service category
        const serviceCategoryId = document.getElementById('serviceCategoryId');
        const serviceCategoryIdError = document.getElementById('serviceCategoryIdError');
        if (!serviceCategoryId.value) {
            serviceCategoryId.classList.add('invalid');
            serviceCategoryIdError.style.display = 'block';
            isValid = false;
        } else {
            serviceCategoryId.classList.remove('invalid');
            serviceCategoryIdError.style.display = 'none';
        }

        // Validate service type
        const serviceType = document.getElementById('serviceType');
        const serviceTypeError = document.getElementById('serviceTypeError');
        if (!serviceType.value) {
            serviceType.classList.add('invalid');
            serviceTypeError.style.display = 'block';
            isValid = false;
        } else {
            serviceType.classList.remove('invalid');
            serviceTypeError.style.display = 'none';
        }

        // Validate service price
        const servicePrice = document.getElementById('servicePrice');
        const servicePriceError = document.getElementById('servicePriceError');
        if (!servicePrice.value || parseInt(servicePrice.value) < 0) {
            servicePrice.classList.add('invalid');
            servicePriceError.style.display = 'block';
            isValid = false;
        } else {
            servicePrice.classList.remove('invalid');
            servicePriceError.style.display = 'none';
        }

        // Validate duration minutes
        const durationMinutes = document.getElementById('durationMinutes');
        const durationMinutesError = document.getElementById('durationMinutesError');
        const duration = parseInt(durationMinutes.value);
        if (!durationMinutes.value || duration < 1 || duration > 32767) {
            durationMinutes.classList.add('invalid');
            durationMinutesError.style.display = 'block';
            isValid = false;
        } else {
            durationMinutes.classList.remove('invalid');
            durationMinutesError.style.display = 'none';
        }

        if (!isValid) {
            event.preventDefault();
            alert('Please correct the errors in the form before submitting.');
        }
    });

    // Real-time validation on input
    document.getElementById('serviceName').addEventListener('input', function() {
        if (this.value.trim()) {
            this.classList.remove('invalid');
            document.getElementById('serviceNameError').style.display = 'none';

            // Check for duplicate name with debounce
            clearTimeout(serviceNameCheckTimeout);
            serviceNameCheckTimeout = setTimeout(() => {
                checkDuplicateServiceName(this.value);
            }, 500);
        } else {
            document.getElementById('serviceNameWarning').style.display = 'none';
            isDuplicateName = false;
        }
    });

    document.getElementById('serviceCategoryId').addEventListener('change', function() {
        if (this.value) {
            this.classList.remove('invalid');
            document.getElementById('serviceCategoryIdError').style.display = 'none';
        }
    });

    document.getElementById('serviceType').addEventListener('change', function() {
        if (this.value) {
            this.classList.remove('invalid');
            document.getElementById('serviceTypeError').style.display = 'none';
        }
    });

    document.getElementById('servicePrice').addEventListener('input', function() {
        if (this.value && parseInt(this.value) >= 0) {
            this.classList.remove('invalid');
            document.getElementById('servicePriceError').style.display = 'none';
        }
    });

    document.getElementById('durationMinutes').addEventListener('input', function() {
        const duration = parseInt(this.value);
        if (this.value && duration >= 1 && duration <= 32767) {
            this.classList.remove('invalid');
            document.getElementById('durationMinutesError').style.display = 'none';
        }
    });

    // Image preview functionality
    document.getElementById('images').addEventListener('change', function(event) {
        const previewContainer = document.getElementById('imagePreview');
        previewContainer.innerHTML = '';
        
        const files = event.target.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.cssText = 'position: relative; width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb;';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                    
                    imgWrapper.appendChild(img);
                    previewContainer.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            }
        }
    });
</script>
</body>
</html>
