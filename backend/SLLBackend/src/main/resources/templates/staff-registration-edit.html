<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Edit Appointment</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .form-buttons { margin-top: 20px; }
        .form-buttons button { padding: 8px 16px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; }
        .save-btn { background: #007bff; color: white; }
        .save-btn:hover { background: #0056b3; }
        .cancel-btn { background: #6c757d; color: white; }
        .cancel-btn:hover { background: #545b62; }
        .section-title { margin-top: 30px; margin-bottom: 10px; font-size: 1.2em; font-weight: bold; }
    </style>
</head>
<body>
<h1>Edit Appointment</h1>

<form th:action="@{/staff/registration/save/{id}(id=${appointment.id})}" method="post">

    <!-- Appointment Section -->
    <div class="section-title">Appointment Details</div>

    <div class="form-group">
        <label for="name">Name</label>
        <input type="text" name="name" id="name"
               th:placeholder="${appointment.name}" readonly/>
    </div>

    <div class="form-group">
        <label for="phoneNumber">Phone Number</label>
        <input type="text" name="phoneNumber" id="phoneNumber"
               th:placeholder="${appointment.phoneNumber}"/>
    </div>

    <div class="form-group">
        <label for="scheduledAt">Scheduled At</label>
        <input type="datetime-local" name="scheduledAt" id="scheduledAt"
               th:value="${#temporals.format(appointment.scheduledAt, 'yyyy-MM-dd''T''HH:mm')}"/>
    </div>

    <div class="form-group">
        <label for="status">Status</label>
        <select name="status" id="status">
            <option th:each="s : ${allStatuses}" th:value="${s}"
                    th:text="${s}" th:selected="${s == appointment.status}">PENDING</option>
        </select>
    </div>

    <!-- AppointmentDetails Section -->
    <div class="section-title">Appointment Execution Details</div>

    <div class="form-group">
        <label for="userSearch">Assigned User</label>
        <input type="hidden" name="username" id="username"
               th:disabled="${disableDetails}" />

        <input type="text" id="userSearch" th:placeholder="${appointmentDetails.user != null ? appointmentDetails.user.username : ''}"
               th:readonly="${disableDetails}" />
        <div id="userResults" style="border: 1px solid #ddd; padding: 5px; margin-top: 5px;" ></div>
    </div>

    <div class="form-group">
        <label>Scheduled Start</label>
        <input type="datetime-local" th:value="${#temporals.format(appointmentDetails.scheduledStart, 'yyyy-MM-dd''T''HH:mm')}" readonly/>
    </div>

    <div class="form-group">
        <label>Scheduled End</label>
        <input type="datetime-local" th:value="${#temporals.format(appointmentDetails.scheduledEnd, 'yyyy-MM-dd''T''HH:mm')}" readonly/>
    </div>

    <div class="form-group">
        <label for="actualStart">Actual Start</label>
        <input type="datetime-local" name="actualStart" id="actualStart"
               th:value="${#temporals.format(appointmentDetails.actualStart, 'yyyy-MM-dd''T''HH:mm')}"
               th:readonly="${disableDetails}" />
    </div>

    <div class="form-group">
        <label for="actualEnd">Actual End</label>
        <input type="datetime-local" name="actualEnd" id="actualEnd"
               th:value="${#temporals.format(appointmentDetails.actualEnd, 'yyyy-MM-dd''T''HH:mm')}"
               th:readonly="${disableDetails}" />
    </div>

    <div class="form-buttons">
        <button type="submit" class="save-btn">Save</button>
        <button type="button" class="cancel-btn" onclick="window.history.back()">Cancel</button>
    </div>

</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let debounceTimer;

        $('#userSearch').on('input', function () {
            const query = $(this).val();

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (query.length < 2) {
                    $('#userResults').empty();
                    return;
                }

                $.ajax({
                    url: '/staff/registration/user-search',
                    type: 'GET',
                    data: { phone: query },
                    success: function (data) {
                        $('#userResults').empty();
                        data.forEach(user => {
                            $('#userResults').append(
                                `<div class="user-option"
                                  data-username="${user.username}"
                                  data-phonenumber="${user.phoneNumber}">
                                ${user.username} (${user.phoneNumber})
                             </div>`
                            );
                        });
                    }
                });
            }, 350);
        });

        // ✅ When selecting a user from results
        $(document).on('click', '.user-option', function () {
            const phoneNumber = $(this).data('phonenumber');
            const username = $(this).data('username');

            $('#userSearch').val(username); // visible field → phone
            $('#username').val(username); // hidden → username binding for form submission

            $('#userResults').empty(); // ✅ collapse results
        });

        // ✅ Close suggestion box on blur
        $('#userSearch').on('blur', function () {
            setTimeout(() => {
                $('#userResults').empty();
            }, 200);
        });
    });
</script>

</body>
</html>
