<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="#{order-checkout.pageTitle}">Checkout | Salon Loan Loan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Global styles -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <style>
        .checkout-page {
            padding: 2.5rem 0 3rem;
        }

        .checkout-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.8rem;
        }

        .checkout-title {
            margin: 0;
            font-size: 1.8rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            color: var(--accent, #ff8400);
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .checkout-layout {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
            gap: 1.8rem;
            max-width: 1024px;
            margin: 0 auto;
        }

        .checkout-card,
        .summary-card {
            background: #ffffff;
            padding: 2rem 2.2rem;
            border-radius: 24px;
            border: 1px solid #e5e5e5;
            box-shadow: 0 10px 24px rgba(0,0,0,0.04);
        }

        .form-section {
            margin-bottom: 1.9rem;
        }

        .form-section h2 {
            font-size: 1.05rem;
            margin: 0 0 0.9rem;
            color: #333;
            font-weight: 700;
            border-bottom: 2px solid rgba(0,0,0,0.05);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 0.95rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.35rem;
            color: #555;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.85rem 1rem;
            border-radius: 12px;
            border: 1px solid #ddd;
            font-size: 0.95rem;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-textarea {
            resize: vertical;
            min-height: 90px;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent, #ff8400);
            box-shadow: 0 0 0 3px rgba(255,132,0,0.2);
        }

        .error {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .payment-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .payment-option {
            flex: 1;
            min-width: 220px;
            padding: 0.9rem 1rem;
            border-radius: 16px;
            border: 2px solid #e1e1e1;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 0.45rem;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
            background: #fafafa;
        }

        .payment-option input[type="radio"] {
            margin-top: 0.2rem;
        }

        .payment-option:hover {
            border-color: var(--accent, #ff8400);
        }

        .payment-option.selected {
            border-color: var(--accent, #ff8400);
            background: #fff7ec;
            box-shadow: 0 6px 16px rgba(0,0,0,0.04);
        }

        .payment-option-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
        }

        .payment-option-desc {
            margin: 0.15rem 0 0;
            font-size: 0.8rem;
            color: #777;
        }

        .place-order-btn {
            width: 100%;
            margin-top: 0.4rem;
            padding: 0.9rem 1.4rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 999px;
            border: none;
            cursor: pointer;
        }

        .place-order-btn.btn-primary {
            /* uses global btn-primary styles, this only ensures full-width radius */
        }

        .place-order-btn:disabled {
            background: #9ca3af !important;
            cursor: not-allowed;
        }

        .summary-card h2 {
            font-size: 1.05rem;
            margin: 0 0 1rem;
            color: #333;
            font-weight: 700;
            border-bottom: 2px solid rgba(0,0,0,0.05);
            padding-bottom: 0.5rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.45rem 0;
            font-size: 0.95rem;
            border-bottom: 1px solid #f1f1f1;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            padding-top: 0.7rem;
            margin-top: 0.7rem;
            font-size: 1.2rem;
            font-weight: 700;
            color: #16a34a;
            border-top: 2px solid #e5e5e5;
        }

        .alert {
            padding: 0.85rem 1rem;
            margin-bottom: 1.4rem;
            border-radius: 14px;
            font-size: 0.9rem;
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .hidden {
            display: none !important;
        }

        .fulfillment-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .fulfillment-option {
            flex: 1;
            min-width: 220px;
            padding: 1rem 1.2rem;
            border-radius: 16px;
            border: 2px solid #e1e1e1;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
            background: #fafafa;
        }

        .fulfillment-option input[type="radio"] {
            margin-top: 0.2rem;
        }

        .fulfillment-option:hover {
            border-color: var(--accent, #ff8400);
        }

        .fulfillment-option.selected {
            border-color: var(--accent, #ff8400);
            background: #fff7ec;
            box-shadow: 0 6px 16px rgba(0,0,0,0.04);
        }

        .fulfillment-option-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
        }

        .fulfillment-option-desc {
            margin: 0.15rem 0 0;
            font-size: 0.8rem;
            color: #777;
        }

        .pickup-info {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 0.5rem;
        }

        .pickup-info p {
            margin: 0;
            color: #166534;
            font-size: 0.9rem;
        }
        @media (max-width: 900px) {
            .checkout-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .checkout-card,
            .summary-card {
                padding: 1.6rem 1.4rem;
            }
            .checkout-header-row {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div th:replace="~{fragments/header :: site-header}"></div>

<main class="checkout-page">
    <div class="container">

        <div class="checkout-header-row">
            <h1 class="checkout-title" th:text="#{order-checkout.heading.checkout}">Checkout</h1>
            <a href="/cart" class="back-link">‚Üê Back to Cart</a>
        </div>

        <div th:if="${param.error}" class="alert alert-error">
            <span th:text="${param.error}">Error message</span>
        </div>

        <div class="checkout-layout">
            <!-- Left: Form -->
            <div class="checkout-card">
                <form id="checkoutForm"
                      action="/order/checkout"
                      method="post"
                      onsubmit="return validateForm()">

                    <!-- Fulfillment Type Selection -->
                    <div class="form-section">
                        <h2 th:text="#{order-checkout.heading.1-how-would-you-like-to-recei}">1. How would you like to receive your order?</h2>

                        <div class="fulfillment-options">
                            <label class="fulfillment-option selected" onclick="selectFulfillment(this)">
                                <input type="radio" name="fulfillmentType" value="DELIVERY" checked required />
                                <div>
                                    <div class="fulfillment-option-title">üöö Delivery</div>
                                    <p class="fulfillment-option-desc">
                                        Have your order delivered to your address.
                                    </p>
                                </div>
                            </label>

                            <label class="fulfillment-option" onclick="selectFulfillment(this)">
                                <input type="radio" name="fulfillmentType" value="IN_STORE_PICKUP" required />
                                <div>
                                    <div class="fulfillment-option-title">üè™ In-Store Pickup</div>
                                    <p class="fulfillment-option-desc">
                                        Pick up your order at our salon. No shipping fees!
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="form-section">
                        <h2 th:text="#{order-checkout.heading.2-customer-information}">2. Customer Information</h2>

                        <div class="form-group">
                            <label class="form-label" for="customerName" th:text="#{order-checkout.label.full-name-}">Full Name *</label>
                            <input class="form-input" type="text" id="customerName" name="customerName" required />
                            <span class="error" id="nameError">Please enter your full name</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="phoneNumber" th:text="#{order-checkout.label.phone-number-}">Phone Number *</label>
                            <input class="form-input" type="tel" id="phoneNumber" name="phoneNumber"
                                  th:placeholder="#{order-checkout.placeholder.0123456789}" placeholder="0123456789" required />
                            <span class="error" id="phoneError">Please enter a valid phone number</span>
                        </div>
                    </div>

                    <!-- Voucher -->
                    <div class="form-section">
                        <h2 th:text="#{order-checkout.heading.3-voucher}">3. Voucher</h2>

                        <div class="form-group">
                            <label class="form-label" for="voucherCode" th:text="#{order-checkout.label.voucher-code}">Voucher Code</label>

                            <div style="display:flex; gap:0.6rem; align-items:center;">
                                <input class="form-input"
                                       type="text"
                                       id="voucherCode"
                                       name="voucherCode"
                                      th:placeholder="#{order-checkout.placeholder.choose-a-voucher}" placeholder="Choose a voucher‚Ä¶"
                                       readonly />

                                <button type="button"
                                        class="btn-primary"
                                        style="border-radius:999px; padding:0.75rem 1.1rem; white-space:nowrap;"
                                        onclick="openVoucherModal()" th:text="#{order-checkout.btn.choose}">Choose</button>

                                <button type="button"
                                        class="btn-secondary"
                                        style="border-radius:999px; padding:0.75rem 1.1rem; white-space:nowrap;"
                                        onclick="clearVoucher()" th:text="#{order-checkout.btn.clear}">Clear</button>
                            </div>

                            <span class="error" id="voucherError">Unable to load vouchers. Please try again.</span>
                        </div>
                    </div>


                    <!-- Delivery Information -->
                    <div class="form-section" id="deliverySection">
                        <h2 th:text="#{order-checkout.heading.3-delivery-address}">3. Delivery Address</h2>

                        <div class="form-group">
                            <label class="form-label" for="city" th:text="#{order-checkout.label.city-}">City *</label>
                            <select class="form-select" id="city" name="city" required>
                                <option value="">Select a city</option>
                                <option value="Hanoi">Hanoi</option>
                                <option value="Ho Chi Minh City">Ho Chi Minh City</option>
                                <option value="Da Nang">Da Nang</option>
                                <option value="Hai Phong">Hai Phong</option>
                                <option value="Can Tho">Can Tho</option>
                                <option value="Bien Hoa">Bien Hoa</option>
                                <option value="Hue">Hue</option>
                                <option value="Nha Trang">Nha Trang</option>
                                <option value="Buon Ma Thuot">Buon Ma Thuot</option>
                                <option value="Quy Nhon">Quy Nhon</option>
                                <option value="Vung Tau">Vung Tau</option>
                                <option value="Nam Dinh">Nam Dinh</option>
                                <option value="Thai Nguyen">Thai Nguyen</option>
                                <option value="Thai Binh">Thai Binh</option>
                                <option value="Ha Long">Ha Long</option>
                                <option value="Long Xuyen">Long Xuyen</option>
                                <option value="Rach Gia">Rach Gia</option>
                                <option value="Cam Pha">Cam Pha</option>
                                <option value="Vinh">Vinh</option>
                                <option value="My Tho">My Tho</option>
                                <option value="Phan Thiet">Phan Thiet</option>
                                <option value="Ca Mau">Ca Mau</option>
                                <option value="Bac Lieu">Bac Lieu</option>
                                <option value="Phan Rang-Thap Cham">Phan Rang-Thap Cham</option>
                                <option value="Tuy Hoa">Tuy Hoa</option>
                                <option value="Pleiku">Pleiku</option>
                                <option value="Dong Ha">Dong Ha</option>
                                <option value="Tam Ky">Tam Ky</option>
                                <option value="Bac Giang">Bac Giang</option>
                                <option value="Viet Tri">Viet Tri</option>
                                <option value="Ha Tinh">Ha Tinh</option>
                                <option value="Thanh Hoa">Thanh Hoa</option>
                                <option value="Ninh Binh">Ninh Binh</option>
                                <option value="Yen Bai">Yen Bai</option>
                                <option value="Dien Bien Phu">Dien Bien Phu</option>
                                <option value="Lao Cai">Lao Cai</option>
                                <option value="Lang Son">Lang Son</option>
                                <option value="Cao Bang">Cao Bang</option>
                                <option value="Son La">Son La</option>
                                <option value="Hoa Binh">Hoa Binh</option>
                                <option value="Bac Kan">Bac Kan</option>
                                <option value="Tuyen Quang">Tuyen Quang</option>
                                <option value="Ha Giang">Ha Giang</option>
                                <option value="Lai Chau">Lai Chau</option>
                                <option value="Phu Tho">Phu Tho</option>
                                <option value="Quang Ninh">Quang Ninh</option>
                                <option value="Bac Ninh">Bac Ninh</option>
                                <option value="Hai Duong">Hai Duong</option>
                                <option value="Hung Yen">Hung Yen</option>
                                <option value="Ha Nam">Ha Nam</option>
                                <option value="Vinh Phuc">Vinh Phuc</option>
                                <option value="Quang Tri">Quang Tri</option>
                                <option value="Quang Binh">Quang Binh</option>
                                <option value="Quang Nam">Quang Nam</option>
                                <option value="Quang Ngai">Quang Ngai</option>
                                <option value="Binh Dinh">Binh Dinh</option>
                                <option value="Phu Yen">Phu Yen</option>
                                <option value="Khanh Hoa">Khanh Hoa</option>
                                <option value="Ninh Thuan">Ninh Thuan</option>
                                <option value="Binh Thuan">Binh Thuan</option>
                                <option value="Kon Tum">Kon Tum</option>
                                <option value="Gia Lai">Gia Lai</option>
                                <option value="Dak Lak">Dak Lak</option>
                                <option value="Dak Nong">Dak Nong</option>
                                <option value="Lam Dong">Lam Dong</option>
                                <option value="Binh Phuoc">Binh Phuoc</option>
                                <option value="Tay Ninh">Tay Ninh</option>
                                <option value="Binh Duong">Binh Duong</option>
                                <option value="Dong Nai">Dong Nai</option>
                                <option value="Ba Ria-Vung Tau">Ba Ria-Vung Tau</option>
                                <option value="Long An">Long An</option>
                                <option value="Tien Giang">Tien Giang</option>
                                <option value="Ben Tre">Ben Tre</option>
                                <option value="Tra Vinh">Tra Vinh</option>
                                <option value="Vinh Long">Vinh Long</option>
                                <option value="Dong Thap">Dong Thap</option>
                                <option value="An Giang">An Giang</option>
                                <option value="Kien Giang">Kien Giang</option>
                                <option value="Hau Giang">Hau Giang</option>
                                <option value="Soc Trang">Soc Trang</option>
                            </select>
                            <span class="error" id="cityError">Please select a city</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="ward" th:text="#{order-checkout.label.warddistrict-optio}">Ward/District (Optional)</label>
                            <select class="form-select" id="ward" name="ward">
                                <option value="">Select city first</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="shippingAddress" th:text="#{order-checkout.label.street-address-}">Street Address *</label>
                            <textarea class="form-textarea"
                                      id="shippingAddress"
                                      name="shippingAddress"
                                     th:placeholder="#{order-checkout.placeholder.enter-your-street-address}" placeholder="Enter your street address (house number, street name)"></textarea>
                            <span class="error" id="addressError">Please enter your street address</span>
                        </div>
                    </div>

                    <!-- Pickup Information (shown only for in-store pickup) -->
                    <div class="form-section hidden" id="pickupSection">
                        <h2 th:text="#{order-checkout.heading.3-pickup-information}">3. Pickup Information</h2>
                        <div class="pickup-info">
                            <p><strong>üìç Pickup Location:</strong> Salon Loan Loan</p>
                            <p style="margin-top: 0.5rem;">We will notify you by email when your order is ready for pickup.</p>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="form-section">
                        <h2 id="paymentSectionTitle" th:text="#{order-checkout.heading.4-payment-method}">4. Payment Method</h2>

                        <div class="payment-options" id="paymentOptions">
                            <label class="payment-option" id="bankTransferOption" onclick="selectPayment(this)">
                                <input type="radio" name="paymentMethod" value="BANK_TRANSFER" required />
                                <div>
                                    <div class="payment-option-title">Bank Transfer</div>
                                    <p class="payment-option-desc">
                                        Pay via bank transfer using the instructions after placing your order.
                                    </p>
                                </div>
                            </label>

                            <label class="payment-option" id="codOption" onclick="selectPayment(this)">
                                <input type="radio" name="paymentMethod" value="COD" required />
                                <div>
                                    <div class="payment-option-title">Cash on Delivery</div>
                                    <p class="payment-option-desc">
                                        Pay in cash when your order is delivered.
                                    </p>
                                </div>
                            </label>

                            <label class="payment-option hidden" id="inStoreOption" onclick="selectPayment(this)">
                                <input type="radio" name="paymentMethod" value="IN_STORE" />
                                <div>
                                    <div class="payment-option-title">Pay at Pickup</div>
                                    <p class="payment-option-desc">
                                        Pay in cash or card when you pick up your order.
                                    </p>
                                </div>
                            </label>
                        </div>

                        <span class="error" id="paymentError">Please select a payment method</span>
                    </div>

                    <button type="submit" class="btn-primary place-order-btn" th:text="#{order-checkout.btn.place-order}">Place Order</button>
                </form>
            </div>

            <!-- Right: Summary -->
            <div class="summary-card">
                <h2 th:text="#{order-checkout.heading.order-summary}">Order Summary</h2>

                <div class="summary-item">
                    <span>Items</span>
                    <span th:text="${cartSummary.itemCount}">0</span>
                </div>

                <div class="summary-item">
                    <span>Subtotal</span>
                    <span th:text="${#numbers.formatDecimal(cartSummary.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</span>
                </div>

                <div class="summary-item" id="voucherDiscountRow" style="display:none;">
                    <span>Voucher Discount</span>
                    <span id="voucherDiscountText">-0 VND</span>
                </div>

                <div class="summary-item" id="shippingFeeRow">
                    <span>Shipping Fee</span>
                    <span id="shippingFeeText">0 VND</span>
                </div>

                <div class="summary-total">
                    <span>Total</span>
                    <span id="totalPriceText"
                          th:text="${#numbers.formatDecimal(cartSummary.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</span>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- FOOTER -->
<div th:replace="~{fragments/footer :: site-footer}"></div>

<!-- Voucher Modal -->
<div id="voucherModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeVoucherModal()"></div>

    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="voucherModalTitle">
        <div class="modal-header">
            <h3 id="voucherModalTitle" style="margin:0; font-size:1.1rem;" th:text="#{order-checkout.heading.choose-a-voucher}">Choose a voucher</h3>
            <button type="button" class="modal-close" onclick="closeVoucherModal()" th:text="#{order-checkout.btn.}">‚úï</button>
        </div>

        <div class="modal-body">
            <div id="voucherLoading" class="modal-loading">Loading vouchers‚Ä¶</div>
            <div id="voucherEmpty" class="modal-empty hidden">No vouchers available.</div>
            <div id="voucherList" class="voucher-list"></div>
        </div>
    </div>
</div>


<script>
    let selectedVoucher = null; // { voucherCode, discountType, discountAmount, ... }
    let currentShippingFee = 0;
    // Shipping fee constants
    const HANOI_SHIPPING_FEE = 30000;
    const OTHER_CITIES_SHIPPING_FEE = 70000;
    const subtotalPrice = [[${cartSummary.totalPrice}]];

    // Money formatter to match Thymeleaf: 1,234,567 + ' VND'
    function formatMoney(value) {
        const num = Number(value) || 0;
        return num
            .toString()
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' VND';
    }

    // Ward/District data for major cities
    const cityWards = {
        'Hanoi': ['Ba Dinh', 'Hoan Kiem', 'Tay Ho', 'Long Bien', 'Cau Giay', 'Dong Da', 'Hai Ba Trung', 'Hoang Mai', 'Thanh Xuan', 'Bac Tu Liem', 'Nam Tu Liem', 'Ha Dong', 'Son Tay', 'Soc Son', 'Dong Anh', 'Gia Lam', 'Thanh Tri', 'Thuong Tin', 'Phu Xuyen', 'Ung Hoa', 'My Duc', 'Thach That', 'Quoc Oai', 'Chuong My', 'Dan Phuong', 'Hoai Duc', 'Thanh Oai', 'Me Linh', 'Ba Vi'],
        'Ho Chi Minh City': ['District 1', 'District 2', 'District 3', 'District 4', 'District 5', 'District 6', 'District 7', 'District 8', 'District 9', 'District 10', 'District 11', 'District 12', 'Binh Thanh', 'Go Vap', 'Phu Nhuan', 'Tan Binh', 'Tan Phu', 'Binh Tan', 'Thu Duc', 'Cu Chi', 'Hoc Mon', 'Binh Chanh', 'Nha Be', 'Can Gio'],
        'Da Nang': ['Hai Chau', 'Thanh Khe', 'Son Tra', 'Ngu Hanh Son', 'Lien Chieu', 'Cam Le', 'Hoa Vang', 'Hoang Sa'],
        'Hai Phong': ['Hong Bang', 'Ngo Quyen', 'Le Chan', 'Hai An', 'Kien An', 'Do Son', 'Duong Kinh', 'Thuy Nguyen', 'An Duong', 'An Lao', 'Kien Thuy', 'Tien Lang', 'Vinh Bao', 'Cat Hai', 'Bach Long Vi'],
        'Can Tho': ['Ninh Kieu', 'O Mon', 'Binh Thuy', 'Cai Rang', 'Thot Not', 'Phong Dien', 'Co Do', 'Vinh Thanh', 'Thoi Lai']
    };

    function updateWardOptions() {
        const citySelect = document.getElementById('city');
        const wardSelect = document.getElementById('ward');
        const selectedCity = citySelect.value;

        // Clear existing options
        wardSelect.innerHTML = '<option value="">Select a ward/district</option>';

        // Populate ward options if city has wards defined
        if (selectedCity && cityWards[selectedCity]) {
            cityWards[selectedCity].forEach(ward => {
                const option = document.createElement('option');
                option.value = ward;
                option.textContent = ward;
                wardSelect.appendChild(option);
            });
            wardSelect.disabled = false;
        } else if (selectedCity) {
            // For cities without predefined wards, enable with generic option
            wardSelect.innerHTML = '<option value="">No specific wards available</option>';
            wardSelect.disabled = true;
        } else {
            wardSelect.innerHTML = '<option value="">Select city first</option>';
            wardSelect.disabled = true;
        }
    }
    function computeVoucherDiscount(subtotal, voucher) {
        if (!voucher || !voucher.discountType || voucher.discountAmount == null) return 0;

        const type = String(voucher.discountType).toUpperCase();
        const amount = Number(voucher.discountAmount) || 0;

        let discount = 0;

        if (type === 'PERCENTAGE') {
            // amount is 0..100
            discount = Math.floor(subtotal * (amount / 100));
        } else if (type === 'AMOUNT') {
            discount = amount;
        }

        // clamp 0..subtotal
        discount = Math.max(0, Math.min(discount, subtotal));
        return discount;
    }

    function updateTotals() {
        const discountRow = document.getElementById('voucherDiscountRow');
        const discountText = document.getElementById('voucherDiscountText');
        const totalPriceText = document.getElementById('totalPriceText');

        const discount = computeVoucherDiscount(subtotalPrice, selectedVoucher);

        if (discount > 0) {
            discountRow.style.display = 'flex';

            // Optionally show percent label
            if (selectedVoucher && String(selectedVoucher.discountType).toUpperCase() === 'PERCENTAGE') {
                discountText.textContent = `-${formatMoney(discount)} (${selectedVoucher.discountAmount}%)`;
            } else {
                discountText.textContent = `-${formatMoney(discount)}`;
            }
        } else {
            discountRow.style.display = 'none';
            discountText.textContent = '-0 VND';
        }

        const total = Math.max(0, (Number(subtotalPrice) || 0) - discount + (Number(currentShippingFee) || 0));
        totalPriceText.textContent = formatMoney(total);
    }


    function updateShippingFee() {
        const fulfillmentType = document.querySelector('input[name="fulfillmentType"]:checked');
        const citySelect = document.getElementById('city');
        const shippingFeeRow = document.getElementById('shippingFeeRow');

        let shippingFee = 0;

        if (fulfillmentType && fulfillmentType.value === 'DELIVERY') {
            const city = (citySelect.value || '').toLowerCase();
            if (city === 'hanoi' || city === 'h√† n·ªôi' || city === 'ha noi') {
                shippingFee = HANOI_SHIPPING_FEE;
            } else if (city) {
                shippingFee = OTHER_CITIES_SHIPPING_FEE;
            }
            shippingFeeRow.style.display = 'flex';
        } else {
            shippingFeeRow.style.display = 'none';
        }

        currentShippingFee = shippingFee;
        document.getElementById('shippingFeeText').textContent = formatMoney(shippingFee);

        updateTotals();
    }


    function selectFulfillment(element) {
        document.querySelectorAll('.fulfillment-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        element.classList.add('selected');
        const radio = element.querySelector('input[type="radio"]');
        if (radio) {
            radio.checked = true;
        }

        // Update form sections based on fulfillment type
        const isPickup = radio.value === 'IN_STORE_PICKUP';
        const deliverySection = document.getElementById('deliverySection');
        const pickupSection = document.getElementById('pickupSection');
        const shippingAddress = document.getElementById('shippingAddress');
        const codOption = document.getElementById('codOption');
        const inStoreOption = document.getElementById('inStoreOption');

        const citySelect = document.getElementById('city');

        if (isPickup) {
            deliverySection.classList.add('hidden');
            pickupSection.classList.remove('hidden');
            shippingAddress.removeAttribute('required');
            citySelect.removeAttribute('required');
            codOption.classList.add('hidden');
            inStoreOption.classList.remove('hidden');
            // Uncheck COD if it was selected
            const codRadio = codOption.querySelector('input[type="radio"]');
            if (codRadio.checked) {
                codRadio.checked = false;
                codOption.classList.remove('selected');
            }
        } else {
            deliverySection.classList.remove('hidden');
            pickupSection.classList.add('hidden');
            shippingAddress.setAttribute('required', '');
            citySelect.setAttribute('required', '');
            codOption.classList.remove('hidden');
            inStoreOption.classList.add('hidden');
            // Uncheck IN_STORE if it was selected
            const inStoreRadio = inStoreOption.querySelector('input[type="radio"]');
            if (inStoreRadio.checked) {
                inStoreRadio.checked = false;
                inStoreOption.classList.remove('selected');
            }
        }

        // Update shipping fee when fulfillment type changes
        updateShippingFee();
    }

    function selectPayment(element) {
        document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        element.classList.add('selected');
        const radio = element.querySelector('input[type="radio"]');
        if (radio) {
            radio.checked = true;
        }
    }

    function validateForm() {
        let isValid = true;

        document.querySelectorAll('.error').forEach(err => err.style.display = 'none');

        const name = document.getElementById('customerName').value.trim();
        if (name.length < 2) {
            document.getElementById('nameError').style.display = 'block';
            isValid = false;
        }
        const phone = document.getElementById('phoneNumber').value.trim();
        const phoneRegex = /^[0-9]{10,11}$/;
        if (!phoneRegex.test(phone)) {
            document.getElementById('phoneError').style.display = 'block';
            isValid = false;
        }

        // Only validate address and city for delivery orders
        const fulfillmentType = document.querySelector('input[name="fulfillmentType"]:checked');
        if (fulfillmentType && fulfillmentType.value === 'DELIVERY') {
            const city = document.getElementById('city').value;
            if (!city) {
                document.getElementById('cityError').style.display = 'block';
                isValid = false;
            }

            const address = document.getElementById('shippingAddress').value.trim();
            if (address.length < 10) {
                document.getElementById('addressError').style.display = 'block';
                isValid = false;
            }
        }

        const paymentSelected = document.querySelector('input[name="paymentMethod"]:checked');
        if (!paymentSelected) {
            document.getElementById('paymentError').style.display = 'block';
            isValid = false;
        }

        return isValid;
    }

    let vouchersLoadedOnce = false;

    function openVoucherModal() {
        const modal = document.getElementById('voucherModal');
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');

        // Load vouchers on first open (or you can reload every time if you want)
        if (!vouchersLoadedOnce) {
            loadVouchers();
        }
    }

    function closeVoucherModal() {
        const modal = document.getElementById('voucherModal');
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
    }

    function clearVoucher() {
        selectedVoucher = null;
        document.getElementById('voucherCode').value = '';
        updateTotals();
    }


    async function loadVouchers() {
        const loadingEl = document.getElementById('voucherLoading');
        const emptyEl = document.getElementById('voucherEmpty');
        const listEl = document.getElementById('voucherList');
        const voucherError = document.getElementById('voucherError');

        voucherError.style.display = 'none';
        loadingEl.classList.remove('hidden');
        emptyEl.classList.add('hidden');
        listEl.innerHTML = '';

        try {
            const res = await fetch('/order/voucher', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            if (!res.ok) {
                throw new Error('HTTP ' + res.status);
            }

            const data = await res.json(); // expects array
            vouchersLoadedOnce = true;

            loadingEl.classList.add('hidden');

            if (!Array.isArray(data) || data.length === 0) {
                emptyEl.classList.remove('hidden');
                return;
            }

            data.forEach(v => {
                // Expected fields based on your entity:
                // voucherCode, voucherName, voucherDescription, discountType, discountAmount
                const code = v.voucherCode ?? '';
                const name = v.voucherName ?? 'Voucher';
                const desc = v.voucherDescription ?? '';
                const type = v.discountType ?? '';
                const amount = v.discountAmount ?? '';

                const badgeText = (type && amount !== '') ? `${type}: ${amount}` : 'Voucher';

                const item = document.createElement('div');
                item.className = 'voucher-item';
                item.onclick = () => selectVoucher(v);

                item.innerHTML = `
                    <div class="voucher-top">
                        <div>
                            <div class="voucher-code">${escapeHtml(code)}</div>
                            <div style="font-weight:600; color:#333; margin-top:0.15rem;">${escapeHtml(name)}</div>
                        </div>
                        <div class="voucher-badge">${escapeHtml(badgeText)}</div>
                    </div>
                    <p class="voucher-desc">${escapeHtml(desc)}</p>
                `;

                listEl.appendChild(item);
            });
        } catch (e) {
            loadingEl.classList.add('hidden');
            voucherError.style.display = 'block';
        }
    }

    function selectVoucher(voucherObj) {
        selectedVoucher = voucherObj || null;

        const code = voucherObj?.voucherCode || '';
        document.getElementById('voucherCode').value = code;

        updateTotals();
        closeVoucherModal();
    }


    // basic XSS-safe render helper
    function escapeHtml(str) {
        return String(str ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    // Close modal on ESC
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('voucherModal');
            if (modal && !modal.classList.contains('hidden')) {
                closeVoucherModal();
            }
        }
    });


    document.getElementById('customerName').addEventListener('blur', function() {
        if (this.value.trim().length < 2) {
            document.getElementById('nameError').style.display = 'block';
        } else {
            document.getElementById('nameError').style.display = 'none';
        }
    });

    document.getElementById('phoneNumber').addEventListener('blur', function() {
        const phoneRegex = /^[0-9]{10,11}$/;
        if (!phoneRegex.test(this.value.trim())) {
            document.getElementById('phoneError').style.display = 'block';
        } else {
            document.getElementById('phoneError').style.display = 'none';
        }
    });

    document.getElementById('city').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('cityError').style.display = 'none';
        }
        // Update ward options when city changes
        updateWardOptions();
        // Update shipping fee when city changes
        updateShippingFee();
    });

    document.getElementById('shippingAddress').addEventListener('blur', function() {
        const fulfillmentType = document.querySelector('input[name="fulfillmentType"]:checked');
        if (fulfillmentType && fulfillmentType.value === 'DELIVERY') {
            if (this.value.trim().length < 10) {
                document.getElementById('addressError').style.display = 'block';
            } else {
                document.getElementById('addressError').style.display = 'none';
            }
        }
    });

    // Initialize shipping fee and ward options on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateWardOptions();
        updateShippingFee();
    });
</script>
</body>
</html>
