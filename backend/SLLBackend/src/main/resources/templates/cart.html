<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="#{cart.pageTitle}">Shopping Cart | Salon Loan Loan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Global styles -->
    <link rel="stylesheet" th:href="@{/css/styles.css}"/>

    <style>
        .cart-page { padding: 2.5rem 0 3rem; }

        .cart-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .cart-header-row h1 { margin: 0; font-size: 1.6rem; }

        .cart-wrapper {
            display: grid;
            grid-template-columns: minmax(0, 2.5fr) minmax(260px, 1fr);
            gap: 1.8rem;
            align-items: flex-start;
        }

        .cart-card,
        .cart-summary-card {
            background: #ffffff;
            border-radius: 24px;
            border: 1px solid #e5e5e5;
            box-shadow: 0 10px 24px rgba(0,0,0,0.04);
        }

        .cart-card { padding: 1.6rem 1.8rem; }
        .cart-summary-card { padding: 1.5rem 1.6rem; }

        .cart-empty {
            text-align: center;
            padding: 2.5rem 1.2rem;
            border-radius: 24px;
            border: 1px dashed #dddddd;
            background: #fafafa;
        }
        .cart-empty h2 { margin-top: 0; margin-bottom: 0.5rem; }

        .cart-table-wrapper { width: 100%; overflow-x: auto; }
        .cart-table { width: 100%; border-collapse: collapse; min-width: 640px; }

        .cart-table th,
        .cart-table td {
            padding: 0.75rem 0.9rem;
            text-align: left;
            border-bottom: 1px solid #ececec;
            font-size: 0.9rem;
        }

        .cart-table th { background: #f6f6f6; font-weight: 600; }

        .product-name {
            color: var(--accent, #ff8400);
            text-decoration: none;
            font-weight: 600;
        }
        .product-name:hover { text-decoration: underline; }

        .price { font-weight: 600; color: #1c7c1c; }

        .quantity-input {
            width: 70px;
            padding: 0.4rem 0.5rem;
            border-radius: 999px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            text-align: center;
        }
        .quantity-input:focus {
            outline: none;
            border-color: var(--accent, #ff8400);
            box-shadow: 0 0 0 2px rgba(255,132,0,0.2);
        }

        .remove-btn {
            padding: 0.4rem 0.7rem;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .remove-btn:hover { background: #c82333; }

        .cart-summary-title {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .summary-total {
            margin-top: 0.8rem;
            padding-top: 0.7rem;
            border-top: 2px solid #eee;
            font-size: 1.15rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            color: #1c7c1c;
        }
        .summary-total span:last-child { font-size: 1.2rem; }

        .cart-actions-bottom {
            margin-top: 1.4rem;
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        @media (max-width: 900px) {
            .cart-wrapper { grid-template-columns: minmax(0, 1fr); }
        }
        @media (max-width: 600px) {
            .cart-card, .cart-summary-card { padding: 1.3rem 1.2rem; }
            .cart-header-row { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div th:replace="~{fragments/header :: site-header}"></div>

<main class="cart-page">
    <div class="container">

        <div class="cart-header-row">
            <h1 th:text="#{cart.title}">Shopping Cart</h1>
            <a th:href="@{/products}" class="btn-outline" th:text="#{cart.backToProducts}">
                ← Back to Products
            </a>
        </div>

        <!-- Empty Cart -->
        <div th:if="${#lists.isEmpty(cartItems)}" class="cart-empty">
            <h2 th:text="#{cart.empty.title}">Your cart is empty</h2>
            <p th:text="#{cart.empty.subtitle}">Start shopping to add items to your cart!</p>
            <a th:href="@{/products}" class="btn-primary" style="margin-top:1rem;" th:text="#{cart.empty.browse}">
                Browse Products
            </a>
        </div>

        <!-- Cart with Items -->
        <div th:if="${!#lists.isEmpty(cartItems)}" class="cart-wrapper">

            <!-- LEFT: ITEMS -->
            <section class="cart-card">
                <div class="cart-table-wrapper">
                    <table class="cart-table">
                        <thead>
                        <tr>
                            <th th:text="#{cart.table.product}">Product</th>
                            <th th:text="#{cart.table.price}">Price</th>
                            <th style="width: 110px;" th:text="#{cart.table.quantity}">Quantity</th>
                            <th th:text="#{cart.table.total}">Total</th>
                            <th th:text="#{cart.table.actions}">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${cartItems}">
                            <td>
                                <a th:href="@{/products/{id}(id=${item.product.id})}"
                                   th:text="${item.product.productName}"
                                   class="product-name">
                                    Product Name
                                </a>
                            </td>
                            <td>
                                <span class="price"
                                      th:text="${#numbers.formatDecimal(item.product.currentPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                                    0 VND
                                </span>
                            </td>
                            <td>
                                <input type="number"
                                       class="quantity-input"
                                       min="1"
                                       th:data-product-id="${item.product.id}"
                                       th:data-price="${item.product.currentPrice}"
                                       th:value="${item.amount}"
                                       onchange="updateQuantity(this)"/>
                            </td>
                            <td>
                                <span class="price"
                                      th:id="'item-total-' + ${item.product.id}"
                                      th:text="${#numbers.formatDecimal(item.product.currentPrice * item.amount, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                                    0 VND
                                </span>
                            </td>
                            <td>
                                <form th:action="@{/cart/remove}" method="post" style="display:inline;">
                                    <input type="hidden" name="productId" th:value="${item.product.id}"/>
                                    <button type="submit" class="remove-btn" th:text="#{cart.action.remove}">
                                        Remove
                                    </button>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Bottom actions under table -->
                <div class="cart-actions-bottom">
                    <a th:href="@{/products}" class="btn-outline" th:text="#{cart.action.continueShopping}">
                        ← Continue Shopping
                    </a>
                </div>
            </section>

            <!-- RIGHT: SUMMARY -->
            <aside class="cart-summary-card">
                <h3 class="cart-summary-title" th:text="#{cart.summary.title}">Order Summary</h3>

                <div class="summary-total">
                    <span th:text="#{cart.summary.totalLabel}">Total:</span>
                    <span id="total-price"
                          th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                        0 VND
                    </span>
                </div>

                <a th:href="@{/order/checkout}"
                   class="btn-primary"
                   style="margin-top:1.1rem; display:block; text-align:center;"
                   th:text="#{cart.summary.checkout}">
                    Proceed to Checkout
                </a>
            </aside>

        </div>
    </div>
</main>

<!-- FOOTER -->
<div th:replace="~{fragments/footer :: site-footer}"></div>

<script>
    // i18n strings for JS
    const I18N = {
        updateFailed: /*[[#{cart.js.updateFailed}]]*/ "Error updating quantity:"
    };

    function formatMoney(value) {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' VND';
    }

    function updateQuantity(input) {
        const productId = input.getAttribute('data-product-id');
        const amount = input.value;
        const price = parseInt(input.getAttribute('data-price'));

        if (amount < 1) {
            input.value = 1;
            return;
        }

        fetch('/cart/api/update-quantity', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `productId=${productId}&amount=${amount}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const itemTotalElement = document.getElementById('item-total-' + productId);
                    if (itemTotalElement && data.itemTotal !== undefined) {
                        itemTotalElement.textContent = formatMoney(data.itemTotal);
                    }

                    const totalPriceElement = document.getElementById('total-price');
                    if (totalPriceElement && data.totalPrice !== undefined) {
                        totalPriceElement.textContent = formatMoney(data.totalPrice);
                    }
                }
            })
            .catch(error => {
                console.error(I18N.updateFailed, error);
            });
    }
</script>

</body>
</html>
