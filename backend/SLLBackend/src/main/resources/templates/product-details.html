<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Product Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 800px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #007bff;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .details-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: bold;
            width: 200px;
            color: #555;
        }
        .detail-value {
            flex: 1;
            color: #333;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .active-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
        }
        .active-true {
            background: #28a745;
            color: white;
        }
        .active-false {
            background: #dc3545;
            color: white;
        }
        .add-to-cart-form {
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .add-to-cart-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .add-to-cart-btn:hover {
            background: #0056b3;
        }
        .quantity-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        /* Rating Styles */
        .rating-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .rating-summary {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .rating-average {
            font-size: 48px;
            font-weight: bold;
            color: #ff9800;
            margin-right: 20px;
        }
        .rating-details {
            flex: 1;
        }
        .stars {
            color: #ff9800;
            font-size: 24px;
            margin-bottom: 5px;
        }
        .star {
            display: inline-block;
        }
        .star.filled {
            color: #ff9800;
        }
        .star.empty {
            color: #ddd;
        }
        .rating-count {
            color: #666;
            font-size: 14px;
        }
        .rating-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .rating-form h3 {
            margin-top: 0;
            color: #333;
        }
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            gap: 5px;
            font-size: 32px;
            margin: 15px 0;
            justify-content: flex-end;
        }
        .star-rating input {
            display: none;
        }
        .star-rating label {
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ff9800;
        }
        .comment-input {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            resize: vertical;
        }
        .submit-rating-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .submit-rating-btn:hover {
            background: #218838;
        }
        .feedback-list {
            margin-top: 20px;
        }
        .feedback-item {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .feedback-user {
            font-weight: bold;
            color: #333;
        }
        .feedback-rating {
            color: #ff9800;
            font-size: 18px;
        }
        .feedback-comment {
            color: #555;
            line-height: 1.5;
        }
        .alert {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .login-prompt {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffc107;
            color: #856404;
            margin-bottom: 20px;
        }
        .login-link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .login-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <a href="/products" class="back-link">← Back to Products</a>
    
    <h1>
        <span th:text="${product.productName}">Product Name</span>
        <span class="active-badge" 
              th:classappend="${product.activeStatus} ? 'active-true' : 'active-false'"
              th:text="${product.activeStatus} ? 'Active' : 'Inactive'">Active</span>
    </h1>

    <div class="details-card">
        <div class="detail-row">
            <div class="detail-label">Product ID:</div>
            <div class="detail-value" th:text="${product.id}">1</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Product Name:</div>
            <div class="detail-value" th:text="${product.productName}">Product Name</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Price:</div>
            <div class="detail-value" th:text="${product.currentPrice} + ' VND'">0 VND</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Description:</div>
            <div class="detail-value" th:text="${product.productDescription}">Description</div>
        </div>
        
        <div class="detail-row">
            <div class="detail-label">Status:</div>
            <div class="detail-value" th:text="${product.activeStatus} ? 'Active' : 'Inactive'">Active</div>
        </div>
    </div>

    <div class="add-to-cart-form" th:if="${product.activeStatus}">
        <form action="/cart/add" method="post">
            <input type="hidden" name="productId" th:value="${product.id}" />
            <label for="amount">Quantity:</label>
            <input type="number" id="amount" name="amount" value="1" min="1" class="quantity-input" />
            <button type="submit" class="add-to-cart-btn">Add to Cart</button>
        </form>
    </div>

    <!-- Rating Section -->
    <div class="rating-section">
        <h2>Product Ratings & Reviews</h2>
        
        <!-- Success/Error Messages -->
        <div th:if="${param.ratingSuccess}" class="alert alert-success">
            Rating submitted successfully!
        </div>
        <div th:if="${param.ratingError}" class="alert alert-error">
            <span th:text="${param.ratingError}">Error submitting rating</span>
        </div>
        
        <!-- Rating Summary -->
        <div class="rating-summary" th:if="${totalReviews > 0}">
            <div class="rating-average" th:text="${#numbers.formatDecimal(averageRating, 1, 1)}">0.0</div>
            <div class="rating-details">
                <div class="stars">
                    <span th:each="i : ${#numbers.sequence(1, 5)}" class="star" 
                          th:classappend="${i <= averageRating} ? 'filled' : 'empty'">★</span>
                </div>
                <div class="rating-count" th:text="${totalReviews} + ' review(s)'">0 reviews</div>
            </div>
        </div>
        
        <div th:if="${totalReviews == 0}" class="alert alert-info">
            No reviews yet. Be the first to review this product!
        </div>
        
        <!-- Rating Form (only if user can rate) -->
        <div th:if="${canRate}" class="rating-form">
            <h3 th:text="${userFeedback != null ? 'Update Your Review' : 'Write a Review'}">Write a Review</h3>
            <form action="/products/rate" method="post">
                <input type="hidden" name="productId" th:value="${product.id}" />
                
                <div>
                    <label>Rating:</label>
                    <div class="star-rating">
                        <input type="radio" name="rating" value="5" id="star5" th:checked="${userFeedback?.rating == 5}" required />
                        <label for="star5">★</label>
                        <input type="radio" name="rating" value="4" id="star4" th:checked="${userFeedback?.rating == 4}" />
                        <label for="star4">★</label>
                        <input type="radio" name="rating" value="3" id="star3" th:checked="${userFeedback?.rating == 3}" />
                        <label for="star3">★</label>
                        <input type="radio" name="rating" value="2" id="star2" th:checked="${userFeedback?.rating == 2}" />
                        <label for="star2">★</label>
                        <input type="radio" name="rating" value="1" id="star1" th:checked="${userFeedback?.rating == 1}" />
                        <label for="star1">★</label>
                    </div>
                </div>
                
                <div>
                    <label for="comment">Comment (optional):</label>
                    <textarea id="comment" name="comment" class="comment-input" 
                              placeholder="Share your thoughts about this product..." 
                              th:text="${userFeedback?.comment}"></textarea>
                </div>
                
                <button type="submit" class="submit-rating-btn" 
                        th:text="${userFeedback != null ? 'Update Review' : 'Submit Review'}">Submit Review</button>
            </form>
        </div>
        
        <!-- Login prompt if user is not logged in -->
        <div th:if="${!canRate and !isLoggedIn}" 
             class="login-prompt">
            <a href="/auth/user/login" class="login-link">Log in</a> to rate this product after purchasing it.
        </div>
        
        <!-- Message if logged in but cannot rate -->
        <div th:if="${!canRate and isLoggedIn}" 
             class="alert alert-info">
            You can rate this product after purchasing and receiving it.
        </div>
        
        <!-- List of Feedback -->
        <div class="feedback-list" th:if="${totalReviews > 0}">
            <h3>Customer Reviews</h3>
            <div th:each="feedback : ${feedbackList}" class="feedback-item">
                <div class="feedback-header">
                    <span class="feedback-user" th:text="${feedback.userAccount.username}">Username</span>
                    <span class="feedback-rating">
                        <span th:each="i : ${#numbers.sequence(1, 5)}" 
                              th:text="${i <= feedback.rating} ? '★' : '☆'">★</span>
                    </span>
                </div>
                <div class="feedback-comment" th:if="${feedback.comment != null and !#strings.isEmpty(feedback.comment)}" 
                     th:text="${feedback.comment}">Great product!</div>
            </div>
        </div>
    </div>

</body>
</html>
