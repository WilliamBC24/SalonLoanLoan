<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title th:text="#{staff-registration-edit.pageTitle}">Staff - Edit Appointment | Salon Loan Loan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Global staff layout styles -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <style>
        /* ===== PAGE LAYOUT ===== */
        .edit-page {
            padding: 2.5rem 0 3rem;
            min-height: 100vh;
            background: var(--bg-light);
        }

        .edit-layout-inner {
            max-width: 1200px;
            margin: 0 auto;
        }

        .edit-card {
            background: #fff;
            padding: 2rem 2.3rem;
            border-radius: var(--radius-lg);
            border: 1px solid #e5e7eb;
            box-shadow: var(--shadow-soft);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.6rem;
            gap: 1rem;
        }

        .header-title-block h2 {
            margin: 0;
        }

        .header-title-block .section-kicker {
            margin: 0 0 0.2rem;
        }

        .back-link-pill {
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #fff;
            text-decoration: none;
            font-size: 0.85rem;
            color: #111827;
            white-space: nowrap;
            cursor: pointer;
        }

        .back-link-pill:hover {
            background: #f3f4f6;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 0.7rem 0.9rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .alert-info {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        /* ===== FORM BASE ===== */
        form {
            display: flex;
            flex-direction: column;
            gap: 1.8rem;
        }

        /* 3-column grid, equal widths, equal height cards */
        .edit-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 1.5rem;
            align-items: stretch;
        }

        .edit-col {
            display: flex;
            flex-direction: column;
        }

        .card-block {
            padding: 1.1rem 1.2rem;
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        @media (max-width: 1100px) {
            .edit-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 800px) {
            .edit-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .form-section-header {
            margin-bottom: 0.7rem;
        }

        .form-section-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .form-section-subtitle {
            font-size: 0.8rem;
            color: #6b7280;
            margin: 0.25rem 0 0;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
        }

        input,
        select {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #d1d5db;
            padding: 0.55rem 0.7rem;
            border-radius: 10px;
            background: #fafafa;
            font-size: 0.9rem;
            color: #111827;
        }

        input:focus,
        select:focus {
            background: #fff;
            outline: none;
            border-color: var(--accent-soft);
            box-shadow: 0 0 0 1px rgba(100, 179, 255, 0.35);
        }

        input[readonly] {
            background: #f3f4f6;
            color: #6b7280;
            cursor: default;
        }

        select:disabled,
        input:disabled {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        /* small button */
        .btn-inline {
            margin-top: 0.15rem;
            align-self: flex-start;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #fff;
            font-size: 0.78rem;
            padding: 0.25rem 0.7rem;
            cursor: pointer;
        }

        .btn-inline:hover {
            background: #f3f4f6;
        }

        .btn-inline:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* ===== USER SEARCH DROPDOWN ===== */
        .user-search-wrapper {
            position: relative;
        }

        #userResults {
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            margin-top: 4px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            max-height: 180px;
            overflow-y: auto;
            box-shadow: var(--shadow-soft);
            z-index: 20;
        }

        .user-option {
            padding: 6px 10px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .user-option:hover {
            background: #f3f4f6;
        }

        /* ===== SERVICES COLUMN ===== */
        .services-card {
            gap: 0.8rem;
        }

        /* Search block like appointment register */
        .service-search-wrapper {
            display: flex;
            flex-direction: column;
            flex: 0 0 auto;
        }

        .service-list {
            margin-top: 0.5rem;
            background: #fafafa;
            border-radius: 16px;
            border: 1px solid #e6e6e6;
            max-height: 180px;
            overflow-y: auto;
        }

        .service-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .service-item:last-child {
            border-bottom: none;
        }
        .service-item:hover {
            background: #f3f3f3;
        }

        .services-list-inner {
            border-radius: 12px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 0.6rem 0.75rem;
            /* fixed height, scroll inside itself */
            height: 260px;
            overflow-y: auto;
            margin-top: 0.7rem;
        }

        .service-row {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            padding: 0.45rem 0.3rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .service-row:last-child {
            border-bottom: none;
        }

        .service-main {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            align-items: baseline;
        }

        .service-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .service-meta {
            font-size: 0.85rem;
            color: #6b7280;
            margin: 0;
            text-align: right;
        }

        .service-meta span {
            white-space: nowrap;
        }

        .service-assignee {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .service-assignee label {
            font-size: 0.8rem;
            font-weight: 500;
            color: #4b5563;
        }

        .service-row-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.15rem;
        }

        .service-remove-btn {
            border: none;
            background: #fee2e2;
            color: #b91c1c;
            border-radius: 999px;
            padding: 0.25rem 0.7rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }

        .service-remove-btn:hover {
            background: #fecaca;
        }

        .services-price-summary {
            margin-top: 0.6rem;
            padding: 0.75rem 0.9rem;
            border-radius: 12px;
            background: #fff9e8;
            border: 1px solid #ffe6b0;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ===== EXECUTION COLUMN ===== */
        .execution-card {
            gap: 0.7rem;
        }

        /* ===== BUTTONS ===== */
        .form-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 0.4rem;
        }

        .btn {
            border: none;
            cursor: pointer;
            padding: 0.55rem 1.3rem;
            border-radius: 999px;
            font-size: 0.86rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        @media (max-width: 640px) {
            .edit-card {
                padding: 1.4rem 1.2rem;
            }

            .header-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-buttons {
                flex-direction: column-reverse;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }
        }

        .field-note {
            margin-top: 0.32rem;
            font-size: 0.82rem;
            color: #6b7280;
        }
    </style>
</head>

<body class="staff-layout">

<!-- SIDEBAR -->
<div th:replace="~{fragments/staff-sidebar :: staff-site-header}"></div>

<!-- MAIN -->
<main class="staff-main edit-page">
    <div class="edit-layout-inner">

        <section class="edit-card">

            <!-- Header -->
            <div class="header-row">
                <div class="header-title-block">
                    <p class="section-kicker">Appointment Management</p>
                    <h2>Edit Appointment</h2>
                </div>
                <a class="back-link-pill" onclick="window.history.back()">← Back</a>
            </div>

            <!-- Finalized notice -->
            <div th:if="${finalized}" class="alert alert-info">
                This appointment has been finalized. An invoice already exists, so further editing is blocked.
            </div>

            <!-- FORM -->
            <form th:action="@{/staff/registration/save/{id}(id=${appointment.id})}"
                  method="post"
                  id="edit-form"
                  th:attr="data-finalized=${finalized}">

                <div class="edit-grid">

                    <!-- ===== COLUMN 1: APPOINTMENT DETAILS ===== -->
                    <div class="edit-col">
                        <div class="card-block">
                            <div class="form-section-header">
                                <p class="form-section-title">Appointment Details</p>
                                <p class="form-section-subtitle">
                                    Basic customer info and booking times.
                                </p>
                            </div>

                            <div class="field">
                                <label>Name</label>
                                <input type="text"
                                       th:placeholder="${appointment.name}"
                                       readonly />
                            </div>

                            <div class="field">
                                <label>Phone Number</label>
                                <input type="text" name="phoneNumber"
                                       th:value="${appointment.phoneNumber}"
                                       th:readonly="${finalized}" />
                            </div>

                            <div class="field">
                                <label>Status</label>
                                <select name="status" id="statusSelect"
                                        th:disabled="${finalized}">
                                    <option th:each="s : ${allStatuses}"
                                            th:value="${s}"
                                            th:text="${s}"
                                            th:selected="${s == appointment.status}">
                                    </option>
                                </select>
                            </div>

                            <div class="field">
                                <label>Preferred Staff</label>
                                <!-- informational only, not editable -->
                                <input type="text"
                                       th:value="${appointment.preferredStaffId != null ? appointment.preferredStaffId.name : 'No preference'}"
                                       readonly />
                                <!-- hidden id for JS default staff -->
                                <input type="hidden" id="preferredStaffSelect"
                                       th:value="${appointment.preferredStaffId != null ? appointment.preferredStaffId.id : ''}" />
                            </div>

                            <div class="field">
                                <label>Assigned Staff</label>
                                <select name="assignedStaffId"
                                        sec:authorize="hasAnyRole('MANAGER', 'ADMIN')"
                                        th:disabled="${finalized}">
                                    <option value="">Select staff…</option>
                                    <option th:each="staff : ${allStaff}"
                                            th:value="${staff.id}"
                                            th:text="${staff.staff.name}"
                                            th:selected="${
                                                        appointment.responsibleStaffId != null
                                                          ? staff.id == appointment.responsibleStaffId.id
                                                          : (appointment.responsibleStaffId != null
                                                                ? staff.id == appointment.responsibleStaffId.id
                                                                : false)
                                                    }">
                                    </option>
                                </select>
                                <div class="field-note">
                                    Choose who will actually handle this appointment in the salon.
                                </div>
                            </div>


                            <div class="field">
                                <label>Registered Start</label>
                                <input type="datetime-local"
                                       id="registeredAt"
                                       readonly
                                       th:value="${#temporals.format(appointment.registeredAt,'yyyy-MM-dd''T''HH:mm')}" />
                            </div>

                            <div class="field">
                                <label>Scheduled At (Staff Assigned)</label>
                                <!-- editable, default to existing scheduledAt or registered start -->
                                <input type="datetime-local" name="scheduledAt" id="scheduledAt"
                                       th:value="${appointment.scheduledAt != null ?
                                                 #temporals.format(appointment.scheduledAt,'yyyy-MM-dd''T''HH:mm') :
                                                 #temporals.format(appointmentDetails.scheduledStart,'yyyy-MM-dd''T''HH:mm')}"
                                       th:readonly="${finalized}" />
                                <button type="button" class="btn-inline" id="btnUseRegistered"
                                        th:disabled="${finalized}">
                                    Use Registered Start
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ===== HIDDEN STAFF OPTIONS TEMPLATE FOR JS ===== -->
                    <select id="staffOptionsTemplate" style="display:none;">
                        <option th:each="staff : ${allStaff}"
                                th:value="${staff.id}"
                                th:text="${staff.staff.name}">
                        </option>
                    </select>

                    <!-- ===== COLUMN 2: SERVICES & STAFF PER SERVICE ===== -->
                    <div class="edit-col">
                        <div class="card-block services-card">
                            <div class="form-section-header">
                                <p class="form-section-title">Services</p>
                                <p class="form-section-subtitle">
                                    Services in this appointment and who will handle each.
                                </p>
                            </div>

                            <!-- Search + add services (hide when finalized) -->
                            <div class="service-search-wrapper" th:if="${!finalized}">
                                <label for="service-search" class="form-label">Search Services</label>
                                <input type="text"
                                       id="service-search"
                                       class="form-input"
                                       placeholder="Type to search services...">
                                <div class="field-note">
                                    Type to search and click a service to add it to this appointment.
                                </div>
                                <div class="service-list" id="service-list"></div>
                            </div>

                            <!-- Existing + newly added services (selected list) -->
                            <div id="services-list" class="services-list-inner">
                                <div class="service-row"
                                     th:each="rs, iterStat : ${requestedServices}"
                                     th:attr="data-service-id=${rs.service.id}, data-price=${rs.priceAtBooking}">
                                    <!-- Hidden fields for binding -->
                                    <input type="hidden" class="rs-id"
                                           th:name="${'requestedServices[' + iterStat.index + '].id'}"
                                           th:value="${rs.id}" />
                                    <input type="hidden" class="rs-service-id"
                                           th:name="${'requestedServices[' + iterStat.index + '].serviceId'}"
                                           th:value="${rs.service.id}" />
                                    <input type="hidden" class="rs-price"
                                           th:name="${'requestedServices[' + iterStat.index + '].priceAtBooking'}"
                                           th:value="${rs.priceAtBooking}" />

                                    <div class="service-main">
                                        <p class="service-name"
                                           th:text="${rs.service.serviceName}">Service Name</p>
                                        <p class="service-meta">
                                            <span th:text="${#numbers.formatDecimal(rs.priceAtBooking, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                                                0 VND
                                            </span>
                                        </p>
                                    </div>

                                    <div class="service-assignee">
                                        <label>Staff</label>
                                        <select class="rs-staff-select"
                                                th:name="${'requestedServices[' + iterStat.index + '].responsibleStaffId'}"
                                                th:disabled="${disableDetails or finalized}">
                                            <option th:each="staff : ${allStaff}"
                                                    th:value="${staff.id}"
                                                    th:text="${staff.staff.name}"
                                                    th:selected="${
                                                        rs.responsibleStaff != null
                                                          ? staff.id == rs.responsibleStaff.id
                                                          : (appointment.preferredStaffId != null
                                                                ? staff.id == appointment.preferredStaffId.id
                                                                : false)
                                                    }">
                                            </option>
                                        </select>
                                    </div>

                                    <div class="service-row-footer" th:if="${!disableDetails and !finalized}">
                                        <button type="button" class="service-remove-btn">Remove</button>
                                    </div>
                                </div>
                            </div>

                            <div class="services-price-summary">
                                <span>Total Price at Booking</span>
                                <strong><span id="total-price">0</span> VND</strong>
                            </div>
                        </div>
                    </div>

                    <!-- ===== COLUMN 3: EXECUTION DETAILS ===== -->
                    <div class="edit-col">
                        <div class="card-block execution-card">
                            <div class="form-section-header">
                                <p class="form-section-title">Execution Details</p>
                                <p class="form-section-subtitle">
                                    Staff assignment and actual working time.
                                </p>
                            </div>

                            <div class="field">
                                <label>Assigned User</label>
                                <div class="user-search-wrapper">
                                    <input type="hidden" name="username" id="username"
                                           th:disabled="${disableDetails or finalized}" />

                                    <input type="text" id="userSearch"
                                           th:placeholder="${appointmentDetails.user != null ? appointmentDetails.user.username : ''}"
                                           th:readonly="${disableDetails or finalized}" />

                                    <div id="userResults"></div>
                                </div>
                            </div>

                            <div class="field">
                                <label>Actual Start</label>
                                <input type="datetime-local" name="actualStart" id="actualStart"
                                       th:readonly="${disableDetails or appointmentDetails.actualStart != null or finalized}"
                                       th:value="${appointmentDetails.actualStart != null ?
                                                 #temporals.format(appointmentDetails.actualStart,'yyyy-MM-dd''T''HH:mm') : null}" />
                                <button type="button"
                                        class="btn-inline"
                                        id="btnStartNow"
                                        th:disabled="${disableDetails or appointmentDetails.actualEnd != null or finalized}">
                                    Start Now (set & save)
                                </button>
                            </div>

                            <div class="field">
                                <label>Actual End</label>
                                <input type="datetime-local" name="actualEnd" id="actualEnd"
                                       th:readonly="${disableDetails or appointmentDetails.actualEnd != null or appointmentDetails.actualStart == null or finalized}"
                                       th:value="${appointmentDetails.actualEnd != null ?
                                                 #temporals.format(appointmentDetails.actualEnd,'yyyy-MM-dd''T''HH:mm') : null}" />
                                <button type="button"
                                        class="btn-inline"
                                        id="btnCompleteNow"
                                        th:disabled="${disableDetails or appointmentDetails.actualStart == null or appointmentDetails.actualEnd != null or finalized}">
                                    Complete Now (set & save)
                                </button>
                            </div>
                            <button type="button"
                                    class="btn-inline"
                                    th:disabled="${appointmentDetails.actualEnd == null}"
                                    th:onclick="|window.location.href='@{/staff/registration/invoice/{id}(id=${appointment.id})}'|">
                                View Invoice
                            </button>
                        </div>
                    </div>

                </div>

                <!-- BUTTONS -->
                <div class="form-buttons">
                    <button type="submit"
                            class="btn btn-primary"
                            th:disabled="${finalized}">
                        Save Changes
                    </button>
                </div>
            </form>

            <!-- ===== SERVICE IMAGES (only visible when COMPLETED) ===== -->
            <div th:if="${appointment.status.name() == 'COMPLETED'}" class="edit-card" style="margin-top: 2rem;">
                <div class="form-section-header">
                    <p class="form-section-title">Service Images</p>
                    <p class="form-section-subtitle">Upload before and after service photos for this completed appointment.</p>
                </div>

                <!-- Flash Messages -->
                <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
                <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

                <div class="edit-grid" style="grid-template-columns: 1fr 1fr;">
                    <!-- BEFORE IMAGES -->
                    <div class="edit-col">
                        <div class="card-block">
                            <h4 style="margin-bottom: 1rem;">Before Service</h4>

                            <!-- Upload Form -->
                            <form th:action="@{/staff/registration/view/{id}/upload-before-image(id=${appointment.id})}"
                                  method="post"
                                  enctype="multipart/form-data"
                                  style="margin-bottom: 1.5rem;">
                                <div class="field">
                                    <label>Upload Before Image</label>
                                    <input type="file"
                                           name="beforeImage"
                                           accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                           required />
                                </div>
                                <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">
                                    Upload Before Image
                                </button>
                            </form>

                            <!-- Display Uploaded Images -->
                            <div th:if="${beforeImages != null and !beforeImages.isEmpty()}">
                                <h5 style="margin-bottom: 0.8rem;">Uploaded Images:</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                                    <div th:each="img : ${beforeImages}" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                                        <img th:src="@{'/uploads/appointment-images/' + ${img.imagePath.substring(img.imagePath.lastIndexOf('/') + 1)}}"
                                             alt="Before service"
                                             style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;"
                                             onclick="window.open(this.src, '_blank')" />
                                    </div>
                                </div>
                            </div>
                            <p th:if="${beforeImages == null or beforeImages.isEmpty()}"
                               style="color: #666; font-style: italic;">
                                No before images uploaded yet.
                            </p>
                        </div>
                    </div>

                    <!-- AFTER IMAGES -->
                    <div class="edit-col">
                        <div class="card-block">
                            <h4 style="margin-bottom: 1rem;">After Service</h4>

                            <!-- Upload Form -->
                            <form th:action="@{/staff/registration/view/{id}/upload-after-image(id=${appointment.id})}"
                                  method="post"
                                  enctype="multipart/form-data"
                                  style="margin-bottom: 1.5rem;">
                                <div class="field">
                                    <label>Upload After Image</label>
                                    <input type="file"
                                           name="afterImage"
                                           accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                           required />
                                </div>
                                <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">
                                    Upload After Image
                                </button>
                            </form>

                            <!-- Display Uploaded Images -->
                            <div th:if="${afterImages != null and !afterImages.isEmpty()}">
                                <h5 style="margin-bottom: 0.8rem;">Uploaded Images:</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                                    <div th:each="img : ${afterImages}" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                                        <img th:src="@{'/uploads/appointment-images/' + ${img.imagePath.substring(img.imagePath.lastIndexOf('/') + 1)}}"
                                             alt="After service"
                                             style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;"
                                             onclick="window.open(this.src, '_blank')" />
                                    </div>
                                </div>
                            </div>
                            <p th:if="${afterImages == null or afterImages.isEmpty()}"
                               style="color: #666; font-style: italic;">
                                No after images uploaded yet.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function formatCurrency(value) {
        const num = Number(value) || 0;
        return num.toLocaleString('en-US'); // 1,000,000
    }

    $(document).ready(function () {
        let debounceTimer;

        const isFinalized = $('#edit-form').data('finalized') === true
            || $('#edit-form').data('finalized') === 'true';

        /* ========= HELPERS ========= */
        function formatDateForInput(date) {
            const pad = (n) => String(n).padStart(2, '0');
            const yyyy = date.getFullYear();
            const MM = pad(date.getMonth() + 1);
            const dd = pad(date.getDate());
            const hh = pad(date.getHours());
            const mm = pad(date.getMinutes());
            return yyyy + '-' + MM + '-' + dd + 'T' + hh + ':' + mm;
        }

        /* ========= SERVICES: TOTAL PRICE ========= */
        function updateTotalPriceFromServices() {
            let total = 0;
            $('#services-list .service-row').each(function () {
                const price = parseInt($(this).attr('data-price')) || 0;
                total += price;
            });
            $('#total-price').text(formatCurrency(total));
        }

        /* ========= SERVICES: REINDEX NAMES ========= */
        function reindexServiceRows() {
            $('#services-list .service-row').each(function (index) {
                const $row = $(this);
                $row.find('.rs-id')
                    .attr('name', 'requestedServices[' + index + '].id');
                $row.find('.rs-service-id')
                    .attr('name', 'requestedServices[' + index + '].serviceId');
                $row.find('.rs-price')
                    .attr('name', 'requestedServices[' + index + '].priceAtBooking');
                $row.find('.rs-staff-select')
                    .attr('name', 'requestedServices[' + index + '].responsibleStaffId');
            });
        }

        /* ========= INIT (even when finalized) ========= */
        reindexServiceRows();
        updateTotalPriceFromServices();

        // If finalized, do not bind interactive handlers (no edits)
        if (isFinalized) {
            return;
        }

        /* ========= USER SEARCH ========= */
        $('#userSearch').on('input', function () {
            const query = $(this).val();

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (query.length < 1) {
                    $('#userResults').empty();
                    return;
                }

                $.ajax({
                    url: '/staff/registration/user-search',
                    type: 'GET',
                    data: { phone: query },
                    success: function (data) {
                        $('#userResults').empty();
                        data.forEach(user => {
                            $('#userResults').append(
                                `<div class="user-option"
                                      data-username="${user.username}"
                                      data-phonenumber="${user.phoneNumber}">
                                     ${user.username} (${user.phoneNumber})
                                 </div>`
                            );
                        });
                    }
                });
            }, 350);
        });

        $(document).on('click', '.user-option', function () {
            const username = $(this).data('username');
            $('#userSearch').val(username);
            $('#username').val(username);
            $('#userResults').empty();
        });

        $('#userSearch').on('blur', function () {
            setTimeout(() => $('#userResults').empty(), 200);
        });

        /* ========= SCHEDULED AT: COPY REGISTERED ========= */
        $('#btnUseRegistered').on('click', function () {
            const val = $('#registeredAt').val();
            if (val) {
                $('#scheduledAt').val(val);
            }
        });

        /* ========= SERVICES: DUPLICATE CHECK ========= */
        function hasService(serviceId) {
            let found = false;
            $('#services-list .service-row').each(function () {
                if (String($(this).attr('data-service-id')) === String(serviceId)) {
                    found = true;
                    return false;
                }
            });
            return found;
        }

        /* ========= SERVICES: REMOVE ========= */
        $('#services-list').on('click', '.service-remove-btn', function () {
            $(this).closest('.service-row').remove();
            reindexServiceRows();
            updateTotalPriceFromServices();
        });

        /* ========= SERVICES: SEARCH ========= */
        $('#service-search').on('input', function () {
            const query = $(this).val().trim();

            if (query.length < 1) {
                $('#service-list').empty();
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                $.ajax({
                    url: '/services/search',
                    method: 'GET',
                    data: { query: query },
                    success: function (data) {
                        const $list = $('#service-list');
                        $list.empty();

                        if (!data || data.length === 0) {
                            return;
                        }

                        data.forEach(s => {
                            const priceDisplay = formatCurrency(s.servicePrice);
                            $list.append(`
                                <div class="service-item"
                                     data-id="${s.id}"
                                     data-name="${s.serviceName}"
                                     data-price="${s.servicePrice}">
                                    ${s.serviceName} - ${priceDisplay} VND
                                </div>
                            `);
                        });

                    },
                    error: function (err) {
                        console.error('Error fetching services', err);
                    }
                });
            }, 300);
        });

        /* ========= SERVICES: CLICK TO ADD ========= */
        $(document).on('click', '.service-item', function () {
            const serviceId = $(this).data('id');
            const serviceName = $(this).data('name');
            const servicePrice = parseInt($(this).data('price')) || 0;

            // Disallow duplicates
            if (hasService(serviceId)) {
                $('#service-list').empty();
                $('#service-search').val('');
                return;
            }

            const preferredStaffId = $('#preferredStaffSelect').val() || '';
            const priceDisplay = formatCurrency(servicePrice);

            // Build row
            const $row = $(`
                <div class="service-row"
                     data-service-id="${serviceId}"
                     data-price="${servicePrice}">
                    <input type="hidden" class="rs-id" name="" value="" />
                    <input type="hidden" class="rs-service-id" name="" value="${serviceId}" />
                    <input type="hidden" class="rs-price" name="" value="${servicePrice}" />

                    <div class="service-main">
                        <p class="service-name">${serviceName}</p>
                        <p class="service-meta">
                            <span>${priceDisplay} VND</span>
                        </p>
                    </div>

                    <div class="service-assignee">
                        <label>Staff</label>
                        <select class="rs-staff-select"></select>
                    </div>

                    <div class="service-row-footer">
                        <button type="button" class="service-remove-btn">Remove</button>
                    </div>
                </div>
            `);

            // Populate staff dropdown from template
            const $templateOptions = $('#staffOptionsTemplate').html();
            const $select = $row.find('.rs-staff-select');
            $select.html($templateOptions);

            if (preferredStaffId) {
                $select.val(preferredStaffId);
            } else {
                const firstVal = $select.find('option:first').val();
                $select.val(firstVal);
            }

            $('#services-list').append($row);

            reindexServiceRows();
            updateTotalPriceFromServices();

            $('#service-list').empty();
            $('#service-search').val('');
        });

        // Hide search results when clicking outside
        $(document).on('click', function (e) {
            if (!$(e.target).closest('#service-search, #service-list').length) {
                $('#service-list').empty();
            }
        });

        /* ========= STATUS SHORTCUT BUTTONS ========= */

        $('#btnStartNow').on('click', function () {
            if ($(this).is(':disabled')) return;

            const now = formatDateForInput(new Date());
            $('#actualStart').val(now);
            $('#statusSelect').val('STARTED'); // assumes enum name STARTED
            $('#edit-form')[0].submit();
        });

        $('#btnCompleteNow').on('click', function () {
            if ($(this).is(':disabled')) return;

            const currentStart = $('#actualStart').val();
            if (!currentStart) {
                return;
            }
            const now = formatDateForInput(new Date());
            $('#actualEnd').val(now);
            $('#statusSelect').val('COMPLETED'); // assumes enum name COMPLETED
            $('#edit-form')[0].submit();
        });
    });
</script>

</body>
</html>
